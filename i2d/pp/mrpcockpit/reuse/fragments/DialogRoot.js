/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("i2d.pp.mrpcockpit.reuse.util.Helper");jQuery.sap.require("i2d.pp.mrpcockpit.reuse.util.CommonConstants");jQuery.sap.require("sap.ca.ui.utils.busydialog");jQuery.sap.require("sap.ca.ui.message.message");jQuery.sap.require("sap.ca.ui.model.type.Number");jQuery.sap.require("sap.ca.ui.model.format.QuantityFormat");jQuery.sap.require("sap.ca.scfld.md.controller.BaseDetailController");jQuery.sap.require("sap.ui.core.format.NumberFormat");jQuery.sap.require("sap.ui.core.Configuration");sap.ca.scfld.md.controller.BaseDetailController.extend("i2d.pp.mrpcockpit.reuse.fragments.DialogRoot",{beforeOpen:function(c){this.dialogAction="";this.oDialog=c.getSource();this.Common_i18n=this.oDialog.getModel('Common_i18n').getResourceBundle();this.Constants=i2d.pp.mrpcockpit.reuse.util.CommonConstants;this.bDateValid=true;this.bAmountValid=true;var m=this.oDialog.getModel();m.setProperty("/MRPElementOriginalTotalQty",Number(m.getProperty("/MRPElementOriginalTotalQty")));m.setProperty("/MRPElementChangedTotalQuantity",Number(m.getProperty("/MRPElementChangedTotalQuantity")));m.setProperty("/OrderedChangedQuantity",Number(m.getProperty("/OrderedChangedQuantity")));var h={};h.fnSuccess=function(d,r,e){this._onOdataOrderSuccess(d,r,e)}.bind(this);h.fnError=function(e){this._onOdataOrderError(e)}.bind(this);var H={};H.fnSuccess=function(d,r,e){this._onOdataCRSuccess(d,r,e)}.bind(this);H.fnError=function(e){this._onOdataCRError(e)}.bind(this);this._oHandlerOrder=h;this._oHandlerCR=H;this._initializeDialog()},_initializeDialog:function(){},_fireEventODataSuccess:function(m,r){var M=this.oDialog.getModel();M.setProperty("/msg",m);var b=sap.ui.getCore().getEventBus();b.publish(this.Constants.EVENT_CHANNELID_CARD_DIALOG_DATACHANGED,this.Constants.EVENT_EVENTID_OK,{model:{cardModel:M,responseModel:r}})},_onOdataOrderSuccess:function(d,r,e){sap.ca.ui.utils.busydialog.releaseBusyDialog();if(e.length>0){var E=i2d.pp.mrpcockpit.reuse.util.Helper.extractErrorMsgFromBatchResponse(this.Common_i18n,e);sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:this.Common_i18n.getText("SOLUTION_DIALOG_"+this.dialogAction+"_MSG_ERROR"),details:E});this._fireEventODataError()}else{this._fireEventODataSuccess(this.Common_i18n.getText("SOLUTION_DIALOG_"+this.dialogAction+"_MSG_SUCCESS"),d)}},_onOdataOrderError:function(e){var E="";sap.ca.ui.utils.busydialog.releaseBusyDialog();if(e&&e.response&&e.response.body){E=i2d.pp.mrpcockpit.reuse.util.Helper.extractErrorMsgFromStream(this.Common_i18n,e.response.body)}else{E=this.Common_i18n.getText("SOLUTION_DIALOG_ERROR_UNKNOWN")}sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:this.Common_i18n.getText("SOLUTION_DIALOG_"+this.dialogAction+"_MSG_ERROR"),details:E});this._fireEventODataError()},_onOdataCRSuccess:function(d,r,e){sap.ca.ui.utils.busydialog.releaseBusyDialog();var D=this.oDialog.getModel().getData();if(e.length>0){var E=i2d.pp.mrpcockpit.reuse.util.Helper.extractErrorMsgFromBatchResponse(this.Common_i18n,e);sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:this.Common_i18n.getText("SOLUTION_DIALOG_MSG_REQUEST_SAVE_FAILED",[D.MRPElementExternalID,D.MRPElementItemExternalID]),details:E});this._fireEventODataError()}else{var R=this.Common_i18n.getText("SOLUTION_DIALOG_MSG_REQUEST_SAVED",[D.MRPElementExternalID,D.MRPElementItemExternalID]);this._fireEventODataSuccess(R,d)}},_onOdataCRError:function(e){var E="";sap.ca.ui.utils.busydialog.releaseBusyDialog();var d=this.oDialog.getModel().getData();if(e&&e.response&&e.response.body){E=i2d.pp.mrpcockpit.reuse.util.Helper.extractErrorMsgFromStream(this.Common_i18n,e.response.body)}else{E=this.Common_i18n.getText("SOLUTION_DIALOG_ERROR_UNKNOWN")}sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:this.Common_i18n.getText("SOLUTION_DIALOG_MSG_REQUEST_SAVE_FAILED",[d.MRPElementExternalID,d.MRPElementItemExternalID]),details:E});this._fireEventODataError()},onOk:function(e){},onCancel:function(e){e.getSource().getParent().close();this.oDialog.close();this.oDialog.destroy();this._fireEventDialogCancel()},_onChangeDatePicker:function(e){if(!e.getParameter("valid")){this._setStatusDate(false,e.getSource(),true);return}var p=e.getSource().getDateValue();var t=new Date();t.setHours(0,0,0,0);if(p<t){this._setStatusDate(false,e.getSource())}else{this._setStatusDate(true,e.getSource())}},_onLiveChangeInput:function(e){var q=e.getParameter("newValue");var c=sap.ui.getCore().getConfiguration().getLocale();var n=sap.ui.core.format.NumberFormat.getInstance({style:"full"},c);var d=n.oFormatOptions.decimalSeparator;var g=n.oFormatOptions.groupingSeparator;var p=q.indexOf(g);var a=q.indexOf(d);var D="["+d+"]";var r=new RegExp(D,'g');var m=this.oDialog.getModel();if((q.charAt(q.length-1)==d)&&(p<a)&&(q.charAt(q.match(r).length)==1)){this._setStatusAmount(true,e.getSource())}else{var Q=n.parse(q);if(isNaN(Q)||(Q<=0)){this._setStatusAmount(false,e.getSource());e.getSource().setValue(e.getParameter("newValue"))}else{var i=q.lastIndexOf(d);if(i>0){var s=q.slice(i+1);var l=s.length;if(l<=m.getProperty("/TargetQuantityUnitDcmls")){this._setStatusAmount(true,e.getSource())}else{this._setStatusAmount(false,e.getSource());e.getSource().setValue(e.getParameter("newValue"))}}else{this._setStatusAmount(true,e.getSource())}}}},_setStatusAmount:function(v,c){this.bAmountValid=v;if(v){c.setValueState(sap.ui.core.ValueState.Info)}else{c.setValueState(sap.ui.core.ValueState.Error)}},_setStatusDate:function(v,c,i){this.bDateValid=v;this.bInvalidDateFormat=i;if(v){c.setValueState(sap.ui.core.ValueState.Info)}else{c.setValueState(sap.ui.core.ValueState.Error)}},_isScreenDataValid:function(){return(this.bDateValid&&this.bAmountValid)},_fireEventODataSent:function(){var b=sap.ui.getCore().getEventBus();b.publish(this.Constants.EVENT_CHANNELID_CARD_DIALOG_DATACHANGED,this.Constants.EVENT_EVENTID_EXECUTE,null)},_fireEventODataError:function(){var b=sap.ui.getCore().getEventBus();b.publish(this.Constants.EVENT_CHANNELID_CARD_DIALOG_DATACHANGED,this.Constants.EVENT_EVENTID_ERROR,null)},_fireEventDialogCancel:function(){var b=sap.ui.getCore().getEventBus();b.publish(this.Constants.EVENT_CHANNELID_CARD_DIALOG_DATACHANGED,this.Constants.EVENT_EVENTID_DIALOG_CANCEL,null)}});
