/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("sap.ca.scfld.md.controller.ScfldMasterController");jQuery.sap.require("i2d.pp.mrpcockpit.reuse.util.CommonConstants");jQuery.sap.require("i2d.pp.mrpcockpit.reuse.util.Helper");jQuery.sap.require("i2d.pp.mrpcockpit.reuse.view.AoRHandler");jQuery.sap.require("i2d.pp.mrpcockpit.reuse.view.VariantHandler");jQuery.sap.require("i2d.pp.mrpcockpit.reuse.util.InteroperabilityHelper");jQuery.sap.require("i2d.pp.mrpcockpit.reuse.view.ViewStateHandler");sap.ca.scfld.md.controller.ScfldMasterController.extend("i2d.pp.mrpcockpit.reuse.view.S2parent",{onInit:function(){sap.ca.scfld.md.controller.ScfldMasterController.prototype.onInit.call(this);i2d.pp.mrpcockpit.reuse.util.InteroperabilityHelper.initialize(this.getView().getModel(),this.getMasterServiceEntity(),this.oApplicationFacade);this.Constants=i2d.pp.mrpcockpit.reuse.util.CommonConstants;var e=jQuery.sap.getModulePath("i2d.pp.mrpcockpit.reuse")+"/"+"i18n/i18n.properties";var b=new sap.ui.model.resource.ResourceModel({bundleUrl:e});this.getView().setModel(b,"Common_i18n");var l=this.getList();var i=l.getItems()[0];l.removeItem(i);this.oListItemTemplate=i;this.oViewState={items:null,variantID:null};this.sStateID=jQuery.sap.uid();var m=/id-.*-.*/;var s=m.exec(sap.ui.core.routing.HashChanger.getInstance().getHash());if(s){this.sStateID=s[0];i2d.pp.mrpcockpit.reuse.view.ViewStateHandler.getViewStateFromContainer(jQuery.proxy(this._resetLastViewState,this),this.sStateID,this.Constants.VIEW_STATE_VALIDITY_TIME,this.oViewState)}else{var c=sap.ui.core.Component.getOwnerIdFor(this.getView());var a=sap.ui.component(c);var C=a.getComponentData();if(C&&C.startupParameters){if(C.startupParameters.OrderCategory){if(C.startupParameters.OrderCategory[0]!==undefined){this.sOrderCategory=C.startupParameters.OrderCategory[0]}}this._bindFilters(C.startupParameters);this.oViewState.variantID=C.startupParameters.VariantID;this.oStartParameters=C.startupParameters}else{if(this._directCall){this.getList().destroyItems();this._directCall()}else{jQuery.sap.log.error("Startup parameter missing. Only direct call use case of app 230 is allowed without startup parameter.");this.oApplicationFacade.oApplicationImplementation.oConnectionManager.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:this.getView().getModel('Common_i18n').getResourceBundle().getText("messURLIncorrect")})}}}var d=sap.ui.getCore().getEventBus();d.subscribe(this.Constants.EVENT_CHANNELID_CARD_DIALOG_DATACHANGED,this.Constants.EVENT_EVENTID_OK,this._updateMasterListItem,this);this.getView().getModel().attachRequestFailed(null,this.handleRequestFailed,this);var f=null;f=this.oApplicationFacade.getApplicationModel("changedItems");if(!f){f=new sap.ui.model.json.JSONModel();this.oApplicationFacade.setApplicationModel("changedItems",f)}this.oApplicationFacade.registerOnMasterListRefresh(this.onMasterRefresh,this);this.oRouter.attachRoutePatternMatched(this._onRoutePatternMatched,this)},getDetailRouteName:function(){if(this.oStartParameters){if(this.oStartParameters.navigationID){if(this.oStartParameters.navigationID[0]==i2d.pp.mrpcockpit.reuse.util.CommonConstants.NavToCR){return i2d.pp.mrpcockpit.reuse.util.CommonConstants.ROUTING.SUB_DETAIL}}}return i2d.pp.mrpcockpit.reuse.util.CommonConstants.ROUTING.DETAIL},getDetailNavigationParameters:function(l){return{contextPath:l.getBindingContext(this.sModelName).getPath().substr(1),stateID:this.sStateID}},_onRoutePatternMatched:function(e){var r=e.getParameter("name");if(r==="master"||r===i2d.pp.mrpcockpit.reuse.util.CommonConstants.ROUTING.DETAIL){var a=e.getParameter("arguments");if(a.stateID&&(a.stateID!==this.sStateID)){var m=/id-.*-.*/;var s=m.exec(a.stateID);if(s){this.sStateID=s[0]}}}},handleRequestFailed:function(e){var E=null;var c=function(){window.history.back()};if(e.getParameter("responseText").match('@AOR@')){i2d.pp.mrpcockpit.reuse.view.AoRHandler.openFirstOnboardingDialog(this.getView().getModel(),this._aorChange.bind(this),this)}else if(e.getParameter("responseText").match('@QuickView@')){}else if(e.getParameter("responseText").match('@NoAuthorization@')){E=this.getView().getModel("Common_i18n").getResourceBundle().getText("MISSING_AUTHORIZATIONS_ERROR");sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:E},c)}else if(e.getParameter("responseText").match('@TOO_MANY_MATERIALS@')){E=this.getView().getModel("Common_i18n").getResourceBundle().getText("TOO_MANY_MATERIALS_ERROR");var b=this.getView().getModel("Common_i18n").getResourceBundle();var a=i2d.pp.mrpcockpit.reuse.util.Helper.extractErrorMsgFromStream(b,e.getParameter("responseText"));var t=a.split("@TOO_MANY_MATERIALS@");t[1].replace(". ","");sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:t[0],details:t[1]})}else{var T=this.getList();if(T){T.setBusy(false);T.setNoDataText(this.getView().getModel('Common_i18n').getResourceBundle().getText("tableUpdateFinished"));this.navToEmptyView()}this.oApplicationFacade.oApplicationImplementation.oConnectionManager.handleRequestFailed(e)}},_updateMasterListItem:function(c,e,d){var a=this.oApplicationFacade.getApplicationModel("changedItems");var s=null;if(this.getList()){s=this.getList().getSelectedItem();if(s){var C=s.getBindingContext();var E=null;E=a.getProperty(C.getPath());if(!E){E={};jQuery.extend(E,C.getObject())}E=this._updateMasterListItemAppSpecific(E,d);if(E){a.setProperty(C.getPath(),E);s.setModel(a);this.oApplicationFacade.setApplicationModel("changedItems",a)}}else{jQuery.sap.log.info("S2: Status Update not possible - No item selected")}}else{jQuery.sap.log.info("S2: Status Update not possible - No list available")}},_updateMasterListItemAppSpecific:function(e,d){e.MaterialShortageStatus=i2d.pp.mrpcockpit.reuse.util.Helper.convertStatusToMasterListStatus(d);return e},_readVariant:function(v,f){this.aFilters=f;this.sVariantContainerPrefix=this._getVariantContainerPrefix();i2d.pp.mrpcockpit.reuse.view.VariantHandler.getVariantByID(this._setFilters.bind(this),this.sVariantContainerPrefix,v)},_setFilters:function(r,o){var i;var j;i2d.pp.mrpcockpit.reuse.util.InteroperabilityHelper.addFilterFrontendVersion(this.aFilters,this.getView().getModel(),this.getMasterServiceEntity());this.aSorter=[];if(o!==null){if(o.MaterialShortageDefinitionID!==undefined){this.aFilters.push(this._getSimpleFilter('MaterialShortageDefinitionID',o.MaterialShortageDefinitionID))}if(o.TimeHorizon!==undefined){this.aFilters.push(this._getSimpleFilter('DynamicHorizonCode',o.TimeHorizon))}if(o.DemandType!==undefined){this.aFilters.push(this._getSimpleFilter('DemandType',o.DemandType))}if(o.OrderCategory!==undefined){this.aFilters.push(this._getSimpleFilter('MRPElementCategory',o.OrderCategory))}if(o.FacetFilterState!==undefined){for(i=0;i<o.FacetFilterState.length;i++){for(j=0;j<o.FacetFilterState[i].selectedItemKeys.length;j++){this.aFilters.push(this._getSimpleFilter(o.FacetFilterState[i].listKey,o.FacetFilterState[i].selectedItemKeys[j][0]))}}}if(o.SortKey&&o.SortDescending!==undefined){this.aSorter.push(new sap.ui.model.Sorter(o.SortKey,o.SortDescending))}}this._handleVariantAppSpecific();this._setupViewBinding(this.aFilters,this.aSorter)},_setupViewBinding:function(f,s){var m=this.getView().byId("list");var M=this.oApplicationFacade.getODataModel();if(!this._isBatchModeActive()){M.setUseBatch(false)}else{M.setUseBatch(true)}M.setSizeLimit(999);m.setGrowingThreshold(50);m.setGrowing(true);m.bindAggregation("items",{path:"/"+this.getMasterListEntity(),template:this.oListItemTemplate,sorter:s,filters:f,parameters:{select:this._getSelectFields()}});this.registerMasterListBind(m)},_bindFilters:function(p){var f=[];var n=null;if(p.navigationID){n=p.navigationID[0]}if(n){var P=sap.ushell.Container.getService('Personalization');if(P.getContainer){P.getContainer(n,this.Constants.VIEW_STATE_VALIDITY_TIME).done(function(c){var i=c.getItemValue("Navigation");if(i){this._bindAppFilters(i,f);this._setupViewBinding(f);this.oViewState.items=i;this._storeViewState()}else{jQuery.sap.log.error("Invalid localBookmark")}}.bind(this))}}else if(p.VariantID){this._readVariant(p.VariantID,f);this.oViewState.variantID=p.VariantID;this._storeViewState()}else{jQuery.sap.log.error("Invalid scenario, either supply display variant or [material,plant,mrparea] combinations");this.oApplicationFacade.oApplicationImplementation.oConnectionManager.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:this.getView().getModel('Common_i18n').getResourceBundle().getText("messURLIncorrect")})}},_handleVariantAppSpecific:function(){},_resetLastViewState:function(r,v){this.oViewState=v;var f=[];if(this.oViewState.items){this._bindAppFilters(this.oViewState.items,f);this._setupViewBinding(f)}else if(this.oViewState.variantID){this._readVariant(this.oViewState.variantID,f)}},_storeViewState:function(){i2d.pp.mrpcockpit.reuse.view.ViewStateHandler.saveViewStateInContainer(null,this.oViewState,this.sStateID,this.Constants.VIEW_STATE_VALIDITY_TIME,null)},_getLocalFilters:function(){var f=[];this._setTimeHorizonFilter(f);this._setShortageFilter(f);this._setControllerFilter(f);this._setPlantFilter(f);return f},_getSimpleFilter:function(f,a){var b=new sap.ui.model.Filter(f,sap.ui.model.FilterOperator.EQ,a);return b},_setTimeHorizonFilter:function(f){var h="";if(h===""){jQuery.sap.log.error("Mandatory url parameter 'timeHorizon' not set!")}f.push(this._getSimpleFilter('DynamicHorizonCode',h))},_setShortageFilter:function(f){var s="";if(s===""){jQuery.sap.log.error("Mandatory url parameter 'shortageDef' not set!")}f.push(this._getSimpleFilter('MaterialShortageDefinitionID',s))},_setPlantFilter:function(f){var p="";if(p!==null){f.push(this._getSimpleFilter('MRPPlant',p))}},_setControllerFilter:function(f){var c="";if(c!==null){f.push(this._getSimpleFilter('MRPController',c))}},_isBatchModeActive:function(){var n="";if(n==="X"){return false}return true},_bindGeneralKeyFilters:function(p,s,a){if((!p.DirectCall)&&(p.MRPArea.length!==p.MaterialID.length||p.MRPArea.length!==p.MRPPlant.length)){jQuery.sap.log.error("Same number of entries for MRPArea, MaterialID and MRPPlant expected")}else{s.push(this._getSimpleFilter('MaterialShortageDefinitionID',p.MaterialShortageDefinitionID));if(p.DirectCall){s.push(this._getSimpleFilter('DirectCall',p.DirectCall))}else{a.push(i2d.pp.mrpcockpit.reuse.util.Helper.getORMultiFilter('MRPArea',p.MRPArea))}a.push(i2d.pp.mrpcockpit.reuse.util.Helper.getORMultiFilter('MaterialID',p.MaterialID));a.push(i2d.pp.mrpcockpit.reuse.util.Helper.getORMultiFilter('MRPPlant',p.MRPPlant));i2d.pp.mrpcockpit.reuse.util.InteroperabilityHelper.addFilterFrontendVersion(s,this.getView().getModel(),this.getMasterServiceEntity())}},onItemsUpdateFinished:function(e){var m=this.getView().byId("list");if(m.getItems().length){var i=m.getSelectedItem();if(i){var r=i.getDomRef();if(r&&e.getParameter("reason")!=="Growing"){r.focus()}}else{this.selectFirstItem()}}else{m.setNoDataText(this.getView().getModel('Common_i18n').getResourceBundle().getText("tableUpdateFinished"));this.navToEmptyView()}},getHeaderFooterOptions:function(){var h={aAdditionalSettingButtons:[{sBtnTxt:"AOR",sI18nBtnTxt:this.getView().getModel('Common_i18n').getResourceBundle().getText("AREA_OF_RESPONSIBILITY"),onBtnPressed:function(e){i2d.pp.mrpcockpit.reuse.view.AoRHandler.openOnboardingDialog(e,this.oApplicationFacade.getODataModel(),this._aorChange.bind(this),this)}.bind(this)}]};if(this.oViewState.variantID&&this.semanticObject&&this.semanticObjectAction){h.buttonList=[{sBtnTxt:"MONITORAPP",sI18nBtnTxt:"NAV_TO_MONITOR_APP",onBtnPressed:function(e){var f=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService;this.oCrossAppNavigator=f&&f("CrossApplicationNavigation");if(this.oCrossAppNavigator){this.oCrossAppNavigator.toExternal({target:{semanticObject:this.semanticObject,action:this.semanticObjectAction},params:{"VariantID":this.oViewState.variantID}})}else{var m=this.oApplicationFacade.getResourceBundle().getText("messNoLaunchpad");sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:m})}}.bind(this)}]}return h},_aorChange:function(){if((arguments[0]==i2d.pp.mrpcockpit.reuse.util.CommonConstants.AOR_DEFINITION_CANCELED)||(arguments[0]==i2d.pp.mrpcockpit.reuse.util.CommonConstants.AOR_DEFINITION_FAILED)){}else{if(this.aFilters){this._setupViewBinding(this.aFilters,this.aSorter)}}},clearFilters:function(){this.aFilters=undefined},clearSorter:function(){this.aSorter=undefined},onExit:function(){var b=sap.ui.getCore().getEventBus();b.unsubscribe(this.Constants.EVENT_CHANNELID_CARD_DIALOG_DATACHANGED,this.Constants.EVENT_EVENTID_OK,this._updateMasterListItem,this);this.oApplicationFacade.deRegisterOnMasterListRefresh(this.onMasterRefresh,this);jQuery(window).unbind("beforeunload");this._storeViewState()},onMasterRefresh:function(e){if(e.getParameter("bManualRefresh")===true){var l=this.getList().getItems();var i;for(i=0;i<l.length;i++){l[i].setModel()}var c=new sap.ui.model.json.JSONModel();this.oApplicationFacade.setApplicationModel("changedItems",c)}else{}}});
