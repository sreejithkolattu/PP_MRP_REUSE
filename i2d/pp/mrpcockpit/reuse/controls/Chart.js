/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.declare("i2d.pp.mrpcockpit.reuse.controls.Chart");jQuery.sap.require("i2d.pp.mrpcockpit.reuse.controls.ChartValue");jQuery.sap.require("sap.ui.thirdparty.d3");jQuery.sap.require("sap.m.MessageToast");sap.ui.core.Control.extend("i2d.pp.mrpcockpit.reuse.controls.Chart",{metadata:{properties:{minBarSize:{type:"int",defaultValue:19},minOverviewBarSize:{type:"float",defaultValue:2},height:{type:"sap.ui.core.CSSSize",defaultValue:"240px"},width:{type:"sap.ui.core.CSSSize",defaultValue:"240px"},minChartHeight:{type:"sap.ui.core.CSSSize",defaultValue:"240px"},fixOverviewHeight:{type:"int",defaultValue:0},showOverview:{type:"boolean",defaultValue:true},shiftLeft:{type:"float",defaultValue:0},allowNavigation:{type:"boolean",defaultValue:false},noNavigationText:{type:"string",defaultValue:""},unitDecimals:{type:"int",defaultValue:0},startBalance:{type:"float",defaultValue:0},minStock:{type:"float",defaultValue:0},safetyStock:{type:"float",defaultValue:0},minDate:"string",maxDate:"string",balanceDotTooltip:{type:"string",defaultValue:""}},aggregations:{values:{type:"i2d.pp.mrpcockpit.reuse.controls.ChartValue",multiple:true,singularName:"value",bindable:"bindable"},deltas:{type:"i2d.pp.mrpcockpit.reuse.controls.ChartValue",multiple:true,singularName:"delta",bindable:"bindable"}},events:{"selected":{}},defaultAggregation:"values"},init:function(){jQuery.sap.require("sap.ca.ui.model.format.DateFormat");jQuery.sap.require("sap.ca.ui.model.format.QuantityFormat");this._oChartFormatter=sap.ca.ui.model.format.DateFormat.getDateInstance({style:'short'});this._dataset="basic";this._duration=2000;this._oChartSettings={};this._oOverviewSettings={};this._ovrBtnLeft=new sap.ui.core.Icon({id:this.getId()+"-ovrBtnLeft",src:"sap-icon://navigation-left-arrow"});this._ovrBtnRight=new sap.ui.core.Icon({id:this.getId()+"-ovrBtnRight",src:"sap-icon://navigation-right-arrow"})},exit:function(){this.removeHandler()},removeHandler:function(){if(this._triggerDeltaDisplay){jQuery.sap.clearDelayedCall(this._triggerDeltaDisplay);this._triggerDeltaDisplay=null}},setDeltas:function(d,n){var h=function(){this.setDeltas(d)};var o=d3.select("#"+this.getId()+"-overview-chartArea svg").remove();var c=d3.select("#"+this.getId()+"-chartArea svg").remove();var a=d3.select("#"+this.getId()+"-backgroundArea svg").remove();var l=(d&&d.length)?d.length:0;var b=this.getDeltas().length;var p=(b>0)&&(this._dataset==="preview");this.removeHandler();if((l>0)&&!p){this.removeAllAggregation("deltas",true);for(var i=0;i<l;i++){this.addAggregation("deltas",new i2d.pp.mrpcockpit.reuse.controls.ChartValue({date:d[i].date,demand:d[i].demand,supply:d[i].supply}),true)}this.calcChartSettings("basic");this.calcChartSettings("preview");this.calcOverviewSettings("basic");this.calcOverviewSettings("preview");if(!n){this.renderChart();this.updateChart()}else{this.renderChart("preview")}this._dataset="preview"}else{var e=this._duration;if(p&&!n){this._duration/=2}this.calcChartSettings("basic");this.calcChartSettings("preview");this.calcOverviewSettings("basic");this.calcOverviewSettings("preview");if(!n){this.renderChart("preview");this.updateChart("basic")}else{this.renderChart("basic")}this._dataset="basic";this.removeAllAggregation("deltas",true);if((l>0)&&p&&!n){this.removeHandler();this._triggerDeltaDisplay=jQuery.sap.delayedCall(this._duration,this,jQuery.proxy(h,this))}this._duration=e}},setHeight:function(h,s){this.setProperty("height",h,true);if(!s){this.resizeChart()}},setWidth:function(w,s){this.setProperty("width",w,true);if(!s){this.resizeChart()}},getDate:function(d){var v=this.getValues();var D="";if(v&&(v.length>d)&&(d>=0)&&(d===parseInt(d))){D=new Date(v[d].getDate())}return D},getDateFormatted:function(d){return this.formatDate(this.getDate(d))},formatDate:function(d){if(d){return this._oChartFormatter.format(d)}return""},formatNumber:function(n){var u=this.getUnitDecimals();var b=(n>=10000)||(n<=-10000);var s=(n<100)&&(n>-100);if(b){return sap.ca.ui.model.format.QuantityFormat.FormatQuantityShort(n,null,u)}else if(s){return sap.ca.ui.model.format.QuantityFormat.FormatQuantityStandard(n,null,u)}else{return sap.ca.ui.model.format.QuantityFormat.FormatQuantityStandard(Math.round(n))}},roundNumber:function(n){return Math.round(n*1000000)/1000000},getDemand:function(d,w){var v=this.getValues();var D=this.getDeltas();var f=0;if(v&&(v.length>d)&&(d>=0)){f=v[d].getDemand();if(!w){var l=(D&&D.length)?D.length:0;for(var i=0;i<l;i++){if(D[i].getDate()==v[d].getDate()){f+=D[i].getDemand()}}}}return f},getSupply:function(d,w){var v=this.getValues();var D=this.getDeltas();var s=0;if(v&&(v.length>d)&&(d>=0)){s=v[d].getSupply();if(!w){var l=(D&&D.length)?D.length:0;for(var i=0;i<l;i++){if(D[i].getDate()==v[d].getDate()){s+=D[i].getSupply()}}}}return s},getShortageAccepted:function(d){var v=this.getValues();if(v&&(v.length>d)&&(d>=0)){return v[d].getShortageAccepted()}return false},reDomain:function(v){if(v>0){var d=Math.pow(10,Math.round(Math.log(v+1)/Math.log(10))-1);return Math.ceil((v+1)/d)*d}else if(v<0){return-this.reDomain(-v)}else{return 0}},convertIntoOverviewPos:function(c,o,p){return Math.round(((p-c.chartSize.leftSpace)/c.daySize*o.daySize+o.chartSize.leftSpace)*10)/10},convertIntoDetailPos:function(c,o,p){return Math.round(((p-o.chartSize.leftSpace)/o.daySize*c.daySize+c.chartSize.leftSpace)*10)/10},isVisible:function(d){var c=this.getChartSettings(d);var o=this.getOverviewSettings(d);var C=jQuery("#"+this.getId());if(C&&C.length){if(C.innerWidth()===0){jQuery.sap.log.debug("Chart has width = 0");return false}}else{jQuery.sap.log.debug("Chart not in DOM tree");return false}if(c.chartSize.chartHeight===0){jQuery.sap.log.debug("Chart has calculated height = 0");return false}if(this.getShowOverview()&&o.chartSize.chartHeight===0){}return true},getChartSettings:function(d){return this._oChartSettings[d]},getOverviewSettings:function(d){return this._oOverviewSettings[d]},getScalingFunctions:function(c,v,t){var s={};var a=c.valueWidth/(t.maxX-t.minX);if((t.maxX-t.minX)===1){s.xScale=d3.scale.linear().domain([-1,0]).range([0,a])}else{s.xScale=d3.scale.linear().domain([t.minX,t.maxX-1]).range([a,c.valueWidth])}s.yScale=d3.scale.linear().domain([v.minY,v.maxY]).range([c.valueHeight,0]);return s},calcChartSettings:function(d){var t={basic:this.getTimeframe("basic"),preview:this.getTimeframe("preview")};var D=this.d3Data(d,t[d]);var a=D.length||2;var f={basic:this.getFirstBalance(t.basic),preview:this.getFirstBalance(t.preview)};var c=jQuery("#"+this.getId()+"-visArea");var b=(c&&c.length)?c.innerWidth():200;var e=(c&&c.length)?c.innerHeight():200;var l=11;var r=12;var T=15;var B=38+10;var m=a*(this.getMinBarSize()/8*21)+(l+r);if(b<m){b=m}var C={leftSpace:l,rightSpace:r,topBorder:T,bottomBorder:B,chartWidth:b,valueWidth:b-(l+r),chartHeight:e,valueHeight:e-(T+B)};var o=t[d];var v=this.getNumberRange(D,d);var s=this.getScalingFunctions(C,v,o);var i=s.xScale(1)-s.xScale(0);var g=(i<48+24)?Math.round(D.length/2):D.length;var h=Math.round(C.valueHeight/40);this._oChartSettings[d]={chartId:this.getId(),firstBalance:f,data:D,timeframe:o,xScale:s.xScale,yScale:s.yScale,tickCntX:g,tickCntY:h,chartSize:C,posY0:s.yScale(0),daySize:i,displayText:true,fireEvent:true}},calcOverviewSettings:function(d){var t={basic:this.getTimeframe("basic"),preview:this.getTimeframe("preview")};var D=this.d3Data(d,t[d]);var a=D.length||2;var f={basic:this.getFirstBalance(t.basic),preview:this.getFirstBalance(t.preview)};var o=jQuery("#"+this.getId()+"-overview-area");var c=jQuery("#"+this.getId()+"-overview-visArea");var b=(c&&c.length)?c.width():200;var e=(c&&c.length)?c.height():0;var C=this.getChartSettings(d);var m=this.getMinOverviewBarSize()/8*21;var g=C.chartSize.chartWidth/C.daySize*m;var h=0;if(m>0){if(b<g){b=g}h=m*b/g}else{h=C.daySize/C.chartSize.chartWidth*b}var l=C.chartSize.leftSpace/C.daySize*h;var r=C.chartSize.rightSpace/C.daySize*h;var T=0;var B=0;var i={leftSpace:l,rightSpace:r,topBorder:T,bottomBorder:B,chartWidth:b,valueWidth:b-(l+r),chartHeight:e,valueHeight:e-(T+B)};var j=t[d];var v=this.getNumberRange(D,d);var s=this.getScalingFunctions(i,v,j);var k=s.xScale(1)-s.xScale(0);var n=(k<48+24)?Math.round(D.length/2):D.length;var p=Math.round(i.valueHeight/40);this._oOverviewSettings[d]={chartId:this.getId()+"-overview",firstBalance:f,data:D,timeframe:j,xScale:s.xScale,yScale:s.yScale,tickCntX:n,tickCntY:p,chartSize:i,posY0:s.yScale(0),daySize:k,displayText:false,fireEvent:false}},getNumberRange:function(D,s){var m=d3.min(D,function(d){return Math.min(0,d[s].balanceStart,d[s].balanceIntraday,d[s].balanceEnd)});var a=d3.max(D,function(d){return Math.max(0,d[s].balanceStart,d[s].balanceIntraday,d[s].balanceEnd)});if(m>-a/20){m=-a/20}if(a<-m/20){a=-m/20}return{minY:this.reDomain(m),maxY:this.reDomain(a)}},getTimeframe:function(d){var m=this.getMinDate();var M=this.getMaxDate();var o=(m)?new Date(m):null;var a=(M)?new Date(M):null;var c=this.getValues();var C=(c)?c.length:0;var b={};var t={minX:0,maxX:C,minXBasic:0,maxXBasic:C};if(o||a){if(d=="preview"){var D=this.getDeltas();var e;var l=(D&&D.length)?D.length:0;for(var i=0;i<l;i++){e=D[i];var f=new Date(e.getDate());if(f<o){o=f}if(f>a){a=f}}var B=this.getTimeframe("basic");t.minXBasic=B.minX;t.maxXBasic=B.maxX}for(var i=0;i<C;i++){b=c[i];if(b.getDate()==o){t.minX=i;break}}for(var i=0;i<C;i++){b=c[i];if(b.getDate()==a){t.maxX=i+1}}}return t},getFirstBalance:function(t,w){var d=0;var s=0;var b=this.getStartBalance();for(var i=0;i<t.minX;i++){d=this.getDemand(i,w);s=this.getSupply(i,w);b=b+d+s}return this.roundNumber(b)},d3Data:function(d,t){var s=false;var D=0;var S=0;var f=0;var a=0;var b=this.getFirstBalance(t,true);var B=this.getFirstBalance(t,false);var m=this.getMinStock();var c=this.getSafetyStock();var o;var e=[];for(var i=t.minX;i<t.maxX;i++){s=this.getShortageAccepted(i);S=this.getSupply(i,true);D=this.getDemand(i,true);a=this.getSupply(i);f=this.getDemand(i);o={index:i,date:this.getDate(i),minStock:m,safetyStock:c,shortageAccepted:s,basic:{balanceStart:this.roundNumber(b),supply:S,balanceIntraday:this.roundNumber(b+S),demand:D,balanceEnd:this.roundNumber(b+S+D)},preview:{balanceStart:this.roundNumber(B),supply:this.getSupply(i),balanceIntraday:this.roundNumber(B+a),demand:this.getDemand(i),balanceEnd:this.roundNumber(B+a+f)}};e.push(o);b+=o.basic.demand+o.basic.supply;B+=o.preview.demand+o.preview.supply}var g=function(i){return e[i]};var l=t.maxX-t.minX;return d3.range(l).map(g)},setChartSize:function(){var c=jQuery("#"+this.getId());if(c&&c.length){var v=c.width();var a=c.height();var o=0;if(this.getShowOverview()){o=this.getFixOverviewHeight();if(!o){o=Math.round(a/8)}}a-=o;var b=jQuery("#"+this.getId()+"-backgroundArea");if(b&&b.length){b[0].style.width=v+"px";b[0].style.height=a+"px"}var d=v;var V=jQuery("#"+this.getId()+"-visArea");if(V&&V.length){V[0].style.height=a+"px";d=V.innerWidth()}this.calcChartSettings("basic");this.calcChartSettings("preview");var C=this.getChartSettings(this._dataset);var e=jQuery("#"+this.getId()+"-chartArea");if(e&&e.length){e[0].style.width=C.chartSize.chartWidth+"px";var m=d-e.outerWidth();var s=Math.min(Math.max(this.getShiftLeft(),m),0);e[0].style.left=s+"px";this.setProperty("shiftLeft",s,true)}if(this.getShowOverview()){var f=v;var O=jQuery("#"+this.getId()+"-overview-area");var g=jQuery("#"+this.getId()+"-overview-visArea");if(O&&O.length){O[0].style.height=o+"px"}if(g&&g.length){f=g.innerWidth()}this.calcOverviewSettings("basic");this.calcOverviewSettings("preview");var h=this.getOverviewSettings(this._dataset);var i=jQuery("#"+this.getId()+"-overview-chartArea");if(i&&i.length){i[0].style.width=h.chartSize.chartWidth+"px";var m=f-i.outerWidth();var s=Math.min(Math.max(i.position().left,m),0);i[0].style.left=s+"px"}var j=jQuery("#"+this.getId()+"-ovrScrollLeft");var k=jQuery("#"+this.getId()+"-ovrScrollRight");if(j&&j.length){var l=j.innerHeight();j[0].style.lineHeight=l+"px";if(l&&(l<16)){j[0].style.fontSize=l+"px"}}if(k&&k.length){var l=k.innerHeight();k[0].style.lineHeight=l+"px";if(l&&(l<16)){k[0].style.fontSize=l+"px"}}}}},showDetailsInOverview:function(){if(!this.getShowOverview()){return}if(!this.isVisible(this._dataset)){return}var c=this.getChartSettings(this._dataset);var o=this.getOverviewSettings(this._dataset);var C=jQuery("#"+this.getId()+"-chartArea");var O=jQuery("#"+this.getId()+"-overview-chartArea");if(C&&C.length&&O&&O.length){var s=-C[0].offsetLeft;var v=C.parent().innerWidth();var a=-O[0].offsetLeft;var b=O.parent().innerWidth();var f=this.convertIntoOverviewPos(c,o,s);var t=this.convertIntoOverviewPos(c,o,s+v-c.chartSize.leftSpace);if(f<a){O[0].style.left=-f+"px"}if(t+o.chartSize.leftSpace>a+b){O[0].style.left=b-t-o.chartSize.leftSpace+"px"}var d=d3.select("#"+o.chartId+"-chartArea svg g");this.updateOverviewWindow(d,o,f,t)}},showOverviewInDetails:function(){var c=this.getChartSettings(this._dataset);var o=this.getOverviewSettings(this._dataset);var C=jQuery("#"+this.getId()+"-chartArea");var O=jQuery("#"+this.getId()+"-overview-chartArea");if(C&&C.length&&O&&O.length){var a=d3.select("#"+o.chartId+"-hidden-left").attr("width");var b=d3.select("#"+o.chartId+"-hidden-right").attr("x");var s=this.convertIntoDetailPos(c,o,a-o.chartSize.leftSpace)+c.chartSize.leftSpace;C[0].style.left=-s+"px";this.setProperty("shiftLeft",-s,true);return-s}return 0},shiftLeftChart:function(p,d){var v=jQuery("#"+p+"-visArea");var c=jQuery("#"+p+"-chartArea");if(v&&v.length&&c&&c.length){var m=v.innerWidth()-c.outerWidth();var s=Math.min(Math.max(this._iStartOffsetX+d,m),0);c[0].style.left=s+"px";this.setProperty("shiftLeft",s,true);return s}return this._iStartOffsetX},shiftLeftOverviewWindow:function(d){var o=d3.select("#"+this.getId()+"-overview-hidden-left");var a=d3.select("#"+this.getId()+"-overview-hidden-right");var b=d3.select("#"+this.getId()+"-overview-hidden-window");var v=jQuery("#"+this.getId()+"-overview-visArea");var c=jQuery("#"+this.getId()+"-overview-chartArea");var e=parseFloat(o.attr("x"));var f=parseFloat(o.attr("width"));var g=parseFloat(a.attr("x"));var h=parseFloat(a.attr("width"));var O=this.getOverviewSettings(this._dataset);if(f+d<0){d=-f}if(h-d<0){d=h}if(f+d<-c[0].offsetLeft){c[0].style.left=-(f+d)+"px"}if(g+d+O.chartSize.leftSpace>v.innerWidth()-c[0].offsetLeft){c[0].style.left=v.innerWidth()-g-d-O.chartSize.leftSpace+"px"}o.attr("width",f+d);a.attr("x",g+d).attr("width",h-d);b.attr("x",e+f+d).attr("width",g-e-f);return d},resizeChart:function(){var c=jQuery("#"+this.getId());if(c&&c.length){var h=this.getHeight();var w=this.getWidth();c[0].style.height=h;c[0].style.width=w;var o=d3.select("#"+this.getId()+"-overview-chartArea svg").remove();var a=d3.select("#"+this.getId()+"-chartArea svg").remove();var b=d3.select("#"+this.getId()+"-backgroundArea svg").remove();this.setChartSize();this.renderChart(this._dataset)}},onShortageSelected:function(d){if(d[this._dataset].balanceEnd<d.safetyStock){if(this.getAllowNavigation()===true){this.fireEvent("selected",d)}else{if(this.getNoNavigationText()!=""){sap.m.MessageToast.show(this.getNoNavigationText())}}}},onclick:function(e){var c=function(n,i){if(n.compareDocumentPosition){return(n===i)||(n.compareDocumentPosition(i)&16)}else if(n.contains){return n.contains(i)}else{return false}};if(!this._tapStart){return}var C=jQuery("#"+this.getId()+"-chartArea");var o=jQuery("#"+this.getId()+"-overview-hidden-window");var O=jQuery("#"+this.getId()+"-ovrScrollLeft");var a=jQuery("#"+this.getId()+"-ovrScrollRight");var b=jQuery("#"+this.getId()+"-overview-hidden-left");var d=jQuery("#"+this.getId()+"-overview-hidden-right");var w=(o)?parseInt(o.attr("width")/2):0;if(C&&C.length&&c(C[0],e.target)){var p=e.getOffsetX();if(e.target.offsetLeft){p+=e.target.offsetLeft};var f=this.getChartSettings(this._dataset);var D=Math.floor((p-f.chartSize.leftSpace)/f.daySize);if((D>=0)&&(f.data[D])){this.onShortageSelected(f.data[D])}}var B=(O&&O.length&&c(O[0],e.target));var h=(b&&b.length&&c(b[0],e.target));if(B||h){this.shiftLeftOverviewWindow(-w);this.showOverviewInDetails()}var g=(a&&a.length&&c(a[0],e.target));var H=(d&&d.length&&c(d[0],e.target));if(g||H){this.shiftLeftOverviewWindow(w);this.showOverviewInDetails()}},move:function(e){var t=e.targetTouches[0]?e.targetTouches[0]:e;var c=(t.pageX)?t.pageX:t.clientX;var m=c-this._iStartMoveX;if(this._bHidden){this._iStartOffsetX=this.shiftLeftChart(this.getId()+"-overview",m);this._iStartMoveX=c}else if(this._bChart){this._iStartOffsetX=this.shiftLeftChart(this.getId(),m);this._iStartMoveX=c;this.showDetailsInOverview()}else if(this._bOverview){this._iStartOffsetX=this.shiftLeftOverviewWindow(m);this._iStartMoveX=c;var s=this.showOverviewInDetails()}if(Math.abs(this._iStartMoveX-this._iTapStartX)>5){this._tapStart=false}},ontouchstart:function(e){var c=function(n,d){if(n.compareDocumentPosition){return(n===d)||(n.compareDocumentPosition(d)&16)}else if(n.contains){return n.contains(d)}else{return false}};var t=e.targetTouches[0]?e.targetTouches[0]:e;var o=jQuery("#"+this.getId()+"-overview-hidden-window");var O=jQuery("#"+this.getId()+"-overview-hidden");var C=jQuery("#"+this.getId()+"-chartArea");this._bOverview=o&&o.length&&c(o[0],t.target);this._bHidden=(!this._bOverview)&&O&&O.length&&c(O[0],t.target);this._bChart=C&&C.length&&c(C[0],t.target);if(this._bHidden){this._iStartOffsetX=o[0].offsetLeft}else if(this._bChart){this._iStartOffsetX=C[0].offsetLeft}else if(this._bOverview){this._iStartOffsetX=o[0].offsetLeft}this._iStartMoveX=(t.pageX)?t.pageX:t.clientX;this._touchStarted=true;this._tapStart=true;this._iTapStartX=this._iStartMoveX;if(this._bOverview){var a=d3.select("#"+this.getId()+"-overview-hidden-window");var s=!this.getFixOverviewHeight();var b=(s)?"sapMRPChartOverviewWindow":"sapMRPChartOverviewWindowSimple";b+=" sapMRPChartExecDrag";a.attr("class",b)}if(this._bChart){C.removeClass("sapMRPChartNavigation");C.removeClass("sapMRPChartStartDrag");C.addClass("sapMRPChartExecDrag")}},ontouchend:function(e){this._touchStarted=false;if(this._bOverview){var o=d3.select("#"+this.getId()+"-overview-hidden-window");var s=!this.getFixOverviewHeight();var c=(s)?"sapMRPChartOverviewWindow":"sapMRPChartOverviewWindowSimple";c+=" sapMRPChartStartDrag";o.attr("class",c)}if(this._bChart){var a=this.getAllowNavigation();var C=jQuery("#"+this.getId()+"-chartArea");C.removeClass("sapMRPChartExecDrag");if(a){C.addClass("sapMRPChartNavigation")}else{C.addClass("sapMRPChartStartDrag")}}},ontouchmove:function(e){this.move(e);e.preventDefault();e.stopPropagation()},onBeforeRendering:function(){this.removeHandler()},onAfterRendering:function(){this.setChartSize();this.renderChart()},renderer:function(r,c){var a=c.getAllowNavigation();r.write("<div");r.writeControlData(c);r.addClass("sapMRPChart");r.writeClasses();var m=c.getMinChartHeight();if(m){r.addStyle("min-height",m)}r.addStyle("height",c.getHeight());r.addStyle("width",c.getWidth());r.writeStyles();r.write(">");r.write("<div id='");r.writeEscaped(c.getId());r.write("-backgroundArea' class='sapMRPChartBackground'>");r.write("</div>");r.write("<div id='");r.writeEscaped(c.getId());r.write("-visArea' class='sapMRPChartVisArea'>");r.write("<div id='");r.writeEscaped(c.getId());r.write("-chartArea'");r.addClass("sapMRPChartArea");if(a){r.addClass("sapMRPChartNavigation")}else{r.addClass("sapMRPChartStartDrag")}r.writeClasses();r.write(">");r.write("</div>");r.write("</div>");r.write("<div id='");r.writeEscaped(c.getId());r.write("-overview-area'");r.addClass("sapMRPChartOverview");if(c.getFixOverviewHeight()){}r.writeClasses();r.write(">");r.write("<div id='");r.writeEscaped(c.getId());r.write("-overview-visArea' class='sapMRPChartOverviewVisArea'>");r.write("<div id='");r.writeEscaped(c.getId());r.write("-overview-chartArea' class='sapMRPChartOverviewArea'>");r.write("</div>");r.write("</div>");if(c._ovrBtnLeft){r.write("<div id='");r.writeEscaped(c.getId());r.write("-ovrScrollLeft' class='sapMRPChartOverviewScrollLeft'>");if(c.getShowOverview()){r.renderControl(c._ovrBtnLeft)}r.write("</div>")};if(c._ovrBtnRight){r.write("<div id='");r.writeEscaped(c.getId());r.write("-ovrScrollRight' class='sapMRPChartOverviewScrollRight'>");if(c.getShowOverview()){r.renderControl(c._ovrBtnRight)}r.write("</div>")};r.write("</div>");r.write("</div>")},renderBackground:function(D,c){var C=jQuery("#"+c.chartId);var b=0;if(C&&C.length){var b=C.width()}var a=d3.select("#"+c.chartId+"-backgroundArea").append("svg:svg").attr("id",c.chartId+"-background").attr("width",b).attr("height",c.chartSize.chartHeight);var v=a.append("svg:g").attr("transform","translate(0,"+c.chartSize.topBorder+")");if((b>16+47)&&(c.chartSize.valueHeight>0)){v.append("svg:rect").attr("id",c.chartId+"-background-border").attr("class","sapMRPChartBorder").attr("x",47).attr("y",c.chartSize.topSpace).attr("width",b-16-47).attr("height",c.chartSize.valueHeight)}var y=v.append("svg:g").attr("class","yAxis");var e=y.selectAll("g.y").data(c.yScale.ticks(c.tickCntY),function(d){return d}).enter().append("svg:g").attr("class","y");e.append("svg:line").attr("class",function(d){return(d!=0)?"yLine sapMRPChartYLine":"yLine sapMRPChartAxis"}).attr("x1",42).attr("x2",b-16).attr("y1",c.yScale).attr("y2",c.yScale);var m=0;var t=40;var s="";var f=e.append("svg:text").attr("class","yText sapMRPChartYAxisDescr").attr("x",40).attr("y",c.yScale).attr("dy","5px").attr("text-anchor","end").text(jQuery.proxy(this.formatNumber,this)).attr("style",function(d){var g=this.getComputedTextLength();if(g>m){m=g}return""});if(m>t){s="font-size:"+Math.floor(875/m*t)/1000+"rem";f.attr("style",s)}},updateBackground:function(D,c){var C=jQuery("#"+c.chartId);var b=0;if(C&&C.length){var b=C.width()}var v=d3.select("#"+c.chartId+"-backgroundArea svg g");var y=v.selectAll("g.yAxis");var a=y.selectAll("g.y").data(c.yScale.ticks(c.tickCntY),function(d){return d});var n=a.enter().append("svg:g").attr("class","y");n.append("svg:line").attr("class","yLine sapMRPChartYLine").attr("x1",42).attr("x2",b-16).attr("y1",function(d){return(d<0)?c.chartSize.valueHeight:this._Y0Pos}).attr("y2",function(d){return(d<0)?c.chartSize.valueHeight:this._Y0Pos}).transition().duration(this._duration).attr("y1",c.yScale).attr("y2",c.yScale);n.append("svg:text").attr("class","yText sapMRPChartYAxisDescr").attr("x",40).attr("dy","5px").attr("text-anchor","end").attr("y",function(d){return(d<0)?c.chartSize.valueHeight:this._Y0Pos}).text(jQuery.proxy(this.formatNumber,this)).transition().duration(this._duration).attr("y",c.yScale);a.select("line.yLine").transition().duration(this._duration).attr("y1",c.yScale).attr("y2",c.yScale);a.select("text.yText").transition().duration(this._duration).attr("y",c.yScale);var m=0;var t=40;var f=875;var e=a.select("text.yText").attr("style",function(d){var g=this.getComputedTextLength();if(g>m){m=g}if(this.style.fontSize){f=parseFloat(this.style.fontSize)*1000;return"font-size:"+this.style.fontSize}return""});if(m>t){jQuery.sap.log.debug("adjust font size of "+f+" as text width "+m+" > available text space");var s="font-size:"+Math.floor(f/m*t)/1000+"rem";e.attr("style",s)}var o=a.exit();o.select("line.yLine").transition().duration(this._duration).attr("y1",function(d){return(d>=0)?0:c.chartSize.valueHeight}).attr("y2",function(d){return(d>=0)?0:c.chartSize.valueHeight}).remove();o.select("text.yText").transition().duration(this._duration).attr("y",function(d){return(d>=0)?0:c.chartSize.valueHeight}).remove();o.transition().duration(this._duration).remove()},renderOverviewWindow:function(v,c){var s=!this.getFixOverviewHeight();var C=(s)?"sapMRPChartOverviewWindow":"sapMRPChartOverviewWindowSimple";C+=" sapMRPChartStartDrag";var o=v.append("svg:g").attr("id",c.chartId+"-hidden");o.append("svg:rect").attr("id",c.chartId+"-hidden-border").attr("class","sapMRPChartBorder").attr("x",-c.chartSize.leftSpace).attr("y",1).attr("width",c.chartSize.valueWidth+c.chartSize.leftSpace+c.chartSize.rightSpace).attr("height",c.chartSize.valueHeight-2);o.append("svg:rect").attr("id",c.chartId+"-hidden-left").attr("class","sapMRPChartOverviewHidden").attr("x",-c.chartSize.leftSpace).attr("y",1).attr("width",c.chartSize.leftSpace).attr("height",c.chartSize.valueHeight-2);o.append("svg:rect").attr("id",c.chartId+"-hidden-right").attr("class","sapMRPChartOverviewHidden").attr("x",c.chartSize.valueWidth).attr("y",1).attr("width",c.chartSize.rightSpace).attr("height",c.chartSize.valueHeight-2);o.append("svg:rect").attr("id",c.chartId+"-hidden-window").attr("class",C).attr("x",0).attr("y",1).attr("width",c.chartSize.valueWidth).attr("height",c.chartSize.valueHeight-2)},updateOverviewWindow:function(v,c,f,t){var o=v.select("#"+c.chartId+"-hidden");var r=c.chartSize.chartWidth-t-c.chartSize.leftSpace;if(r<0){r=0}var w=c.chartSize.leftSpace+t-f;if(w<0){w=0}o.select("#"+c.chartId+"-hidden-left").attr("width",f);o.select("#"+c.chartId+"-hidden-right").attr("x",t).attr("width",r);o.select("#"+c.chartId+"-hidden-window").attr("x",-c.chartSize.leftSpace+f).attr("width",w)},renderXAxis:function(v,d,c){var x=v.append("svg:g").attr("id",c.chartId+"-chart-xAxis");x.append("svg:line").attr("class","sapMRPChartAxis").attr("x1",-c.chartSize.leftSpace).attr("x2",c.chartSize.valueWidth+c.chartSize.rightSpace).attr("y1",c.yScale(0)).attr("y2",c.yScale(0))},updateXAxis:function(v,d,c){var x=v.select("#"+c.chartId+"-chart-xAxis");x.select("line").transition().duration(this._duration).attr("x2",c.chartSize.chartWidth).attr("y1",c.yScale(0)).attr("y2",c.yScale(0))},renderDays:function(v,D,c){var a=v.append("svg:g").attr("id",c.chartId+"-chart-days");var b=a.selectAll("rect").data(c.data,function(d){return d.date}).enter().append("rect");b.attr("x",function(d){return c.xScale(d.index-1)}).attr("width",c.daySize).attr("y",c.chartSize.topSpace).attr("height",c.chartSize.valueHeight).attr("class",function(d){var s=((d.index-c.timeframe.minXBasic)%2==0)?"sapMRPChartEvenDay":"sapMRPChartOddDay";return s})},updateDays:function(v,D,c){var a=v.select("#"+c.chartId+"-chart-days");var b=a.selectAll("rect").data(c.data,function(d){return d.date});var n=b.enter().append("rect");n.attr("x",function(d){return(d.index<c.timeframe.minXBasic)?0:c.chartSize.chartWidth}).attr("width",0).attr("y",c.chartSize.topSpace).attr("height",0).transition().duration(this._duration).attr("x",function(d){return c.xScale(d.index-1)}).attr("width",c.daySize).attr("height",function(d){return c.chartSize.valueHeight}).attr("class",function(d){var s=((d.index-c.timeframe.minXBasic)%2==0)?"sapMRPChartEvenDay":"sapMRPChartOddDay";return s});b.transition().duration(this._duration).attr("x",function(d){return c.xScale(d.index-1)}).attr("width",c.daySize).attr("y",c.chartSize.topSpace).attr("height",c.chartSize.valueHeight).attr("class",function(d){var s=((d.index-c.timeframe.minXBasic)%2==0)?"sapMRPChartEvenDay":"sapMRPChartOddDay";return s});b.exit().transition().duration(this._duration).attr("x",function(d){return(d.index<c.timeframe.minXBasic)?0:c.chartSize.chartWidth}).attr("width",0).remove()},renderShortage:function(v,D,c){var s=v.append("svg:g").attr("id",c.chartId+"-chart-shortage");var a=s.selectAll("rect").data(c.data,function(d){return d.date}).enter().append("rect");a.attr("x",function(d){return c.xScale(d.index-1)}).attr("width",c.daySize).attr("y",c.chartSize.topSpace).attr("height",c.chartSize.valueHeight).attr("class",function(d){var S="sapMRPChartNoShortage";if(!d.shortageAccepted){if(d[D].balanceEnd<d.minStock){S="sapMRPChartShortage"}else if(d[D].balanceEnd<d.safetyStock){S="sapMRPChartBelowSafetyStock"}}return S});var b=s.selectAll("line").data(c.data,function(d){return d.date}).enter().append("line");b.attr("x1",function(d){return c.xScale(d.index)}).attr("y1",0).attr("x2",function(d){return c.xScale(d.index)}).attr("y2",c.chartSize.valueHeight).attr("class","sapMRPChartDayDivider")},updateShortage:function(v,D,c){var s=v.select("#"+c.chartId+"-chart-shortage");var a=s.selectAll("rect").data(c.data,function(d){return d.date});var b=s.selectAll("line").data(c.data,function(d){return d.date});var n=a.enter().append("rect");n.attr("x",function(d){return(d.index<c.timeframe.minXBasic)?0:c.chartSize.chartWidth}).attr("width",0).attr("y",c.chartSize.topSpace).attr("height",0).transition().duration(this._duration).attr("x",function(d){return c.xScale(d.index-1)}).attr("width",c.daySize).attr("height",function(d){return c.chartSize.valueHeight}).attr("class",function(d){var S="sapMRPChartNoShortage";if(!d.shortageAccepted){if(d[D].balanceEnd<d.minStock){S="sapMRPChartShortage"}else if(d[D].balanceEnd<d.safetyStock){S="sapMRPChartBelowSafetyStock"}}return S});a.transition().duration(this._duration).attr("x",function(d){return c.xScale(d.index-1)}).attr("width",c.daySize).attr("y",c.chartSize.topSpace).attr("height",function(d){return c.chartSize.valueHeight}).attr("class",function(d){var S="sapMRPChartNoShortage";if(!d.shortageAccepted){if(d[D].balanceEnd<d.minStock){S="sapMRPChartShortage"}else if(d[D].balanceEnd<d.safetyStock){S="sapMRPChartBelowSafetyStock"}}return S});a.exit().transition().duration(this._duration).attr("x",function(d){return(d.index<c.timeframe.minXBasic)?0:c.chartSize.chartWidth}).attr("width",0).remove();var e=b.enter().append("line");e.attr("x1",function(d){return c.xScale(d.index)}).attr("y1",0).attr("x2",function(d){return c.xScale(d.index)}).attr("y2",c.chartSize.valueHeight).attr("class","sapMRPChartDayDivider");b.transition().duration(this._duration).attr("x1",function(d){return c.xScale(d.index)}).attr("y1",0).attr("x2",function(d){return c.xScale(d.index)}).attr("y2",c.chartSize.valueHeight);b.exit().transition().duration(this._duration).attr("x1",function(d){return(d.index<c.timeframe.minXBasic)?0:c.chartSize.chartWidth}).attr("x2",function(d){return(d.index<c.timeframe.minXBasic)?0:c.chartSize.chartWidth}).remove()},renderXTicks:function(v,D,c){var x=v.append("svg:g").attr("id",c.chartId+"-chart-xTicks").attr("minTick",c.timeframe.minX);var a=x.selectAll("g").data(c.xScale.ticks(c.tickCntX),jQuery.proxy(this.getDate,this)).enter().append("svg:g");a.append("svg:text").attr("class","sapMRPChartXAxisDescr").attr("x",function(d){return c.xScale(d)-c.daySize/2}).attr("y",c.chartSize.chartHeight-31).attr("text-anchor","middle").text(jQuery.proxy(this.getDateFormatted,this))},updateXTicks:function(v,D,c){var x=v.select("#"+c.chartId+"-chart-xTicks");var f=x.attr("minTick");var a=x.attr("minTick",c.timeframe.minX).selectAll("g").data(c.xScale.ticks(c.tickCntX),jQuery.proxy(this.getDate,this));var b=a.enter().append("svg:g");b.append("svg:text").attr("class","sapMRPChartXAxisDescr").attr("x",function(i){return(i<f)?0:c.chartSize.chartWidth}).attr("y",c.chartSize.chartHeight-31).attr("text-anchor","middle").text(jQuery.proxy(this.getDateFormatted,this)).transition().duration(this._duration).attr("x",function(i){return c.xScale(i)-c.daySize/2});a.select("text.sapMRPChartXAxisDescr").transition().duration(this._duration).attr("x",function(d){return c.xScale(d)-c.daySize/2});var e=a.exit();e.select("text.sapMRPChartXAxisDescr").transition().duration(this._duration).attr("x",function(i){return(i<c.timeframe.minX)?0:c.chartSize.chartWidth}).remove();e.transition().duration(this._duration).remove()},renderSupply:function(v,D,c){var C=this;var s=v.append("svg:g").attr("id",c.chartId+"-chart-supplies");var a=s.selectAll("g").data(c.data).enter().append("svg:g");a.append("rect").attr("class",function(d){var n=(d[D].supply>d.basic.supply);return(n)?" sapMRPChartNewSupply":"sapMRPChartSupply"}).attr("x",function(d){return c.xScale(d.index)-c.daySize/21*38/2}).attr("width",function(d){return c.daySize/21*8}).attr("y",function(d){return c.yScale(d[D].balanceIntraday)}).attr("height",function(d){return c.yScale(d[D].balanceStart)-c.yScale(d[D].balanceIntraday)});if(c.displayText){a.append("svg:title").text(function(d){return""+(C.formatNumber(d[D].supply))})}},updateSupply:function(v,D,c){var C=this;var s=v.select("#"+c.chartId+"-chart-supplies");var a=s.selectAll("g").data(c.data,function(d){return d.date});var b=a.enter().append("svg:g");b.append("rect").attr("class",function(d){var n=(d[D].supply>d.basic.supply);return(n)?" sapMRPChartNewSupply":"sapMRPChartSupply"}).attr("x",function(d){return(d.index<c.timeframe.minXBasic)?0:c.chartSize.chartWidth}).attr("width",0).attr("y",c.yScale(0)).attr("height",0).transition().duration(this._duration).attr("x",function(d){return c.xScale(d.index)-c.daySize/21*38/2}).attr("width",function(d){return c.daySize/21*8}).attr("y",function(d){return c.yScale(d[D].balanceIntraday)}).attr("height",function(d){return c.yScale(d[D].balanceStart)-c.yScale(d[D].balanceIntraday)});if(c.displayText){b.append("svg:title").text(function(d){return""+(C.formatNumber(d[D].supply))})}a.select("rect").transition().duration(this._duration).attr("class",function(d){var n=(d[D].supply>d.basic.supply);return(n)?"sapMRPChartNewSupply":this.getAttribute("class")}).attr("x",function(d){return c.xScale(d.index)-c.daySize/21*38/2}).attr("width",function(d){return c.daySize/21*8}).attr("y",function(d){return c.yScale(d[D].balanceIntraday)}).attr("height",function(d){return c.yScale(d[D].balanceStart)-c.yScale(d[D].balanceIntraday)}).transition().delay(this._duration).duration(0).attr("class",function(d){var n=(d[D].supply>d.basic.supply);return(n)?" sapMRPChartNewSupply":"sapMRPChartSupply"});if(c.displayText){a.select("title").text(function(d){return""+(C.formatNumber(d[D].supply))})}var e=a.exit();e.select("rect").transition().duration(this._duration).attr("x",function(d){return(d.index<c.timeframe.minXBasic)?0:c.chartSize.chartWidth}).attr("width",0).remove();e.select("text").transition().duration(this._duration).attr("x",function(d){return(d.index<c.timeframe.minXBasic)?0:c.chartSize.chartWidth}).remove();e.transition().duration(this._duration).remove()},renderDemand:function(v,D,c){var C=this;var a=v.append("svg:g").attr("id",c.chartId+"-chart-demands");var b=a.selectAll("g").data(c.data).enter().append("svg:g");b.append("rect").attr("class","sapMRPChartDemand").attr("x",function(d){return c.xScale(d.index)-c.daySize/21*20/2}).attr("width",function(d){return c.daySize/21*8}).attr("y",function(d){return c.yScale(d[D].balanceIntraday)}).attr("height",function(d){return c.yScale(d[D].balanceEnd)-c.yScale(d[D].balanceIntraday)});if(c.displayText){b.append("svg:title").text(function(d){return""+(C.formatNumber(-d[D].demand))})}},updateDemand:function(v,D,c){var C=this;var a=v.select("#"+c.chartId+"-chart-demands");var b=a.selectAll("g").data(c.data,function(d){return d.date});var e=b.enter().append("svg:g");e.append("rect").attr("class","sapMRPChartDemand").attr("x",function(d){return(d.index<c.timeframe.minXBasic)?0:c.chartSize.chartWidth}).attr("width",0).attr("y",c.yScale(0)).attr("height",0).transition().duration(this._duration).attr("x",function(d){return c.xScale(d.index)-c.daySize/21*20/2}).attr("width",function(d){return c.daySize/21*8}).attr("y",function(d){return c.yScale(d[D].balanceIntraday)}).attr("height",function(d){return c.yScale(d[D].balanceEnd)-c.yScale(d[D].balanceIntraday)});if(c.displayText){e.append("svg:title").text(function(d){return""+(C.formatNumber(-d[D].demand))})}b.select("rect").transition().duration(this._duration).attr("x",function(d){return c.xScale(d.index)-c.daySize/21*20/2}).attr("width",function(d){return c.daySize/21*8}).attr("y",function(d){return c.yScale(d[D].balanceIntraday)}).attr("height",function(d){return c.yScale(d[D].balanceEnd)-c.yScale(d[D].balanceIntraday)});if(c.displayText){b.select("title").text(function(d){return""+(C.formatNumber(-d[D].demand))})}var f=b.exit();f.select("rect").transition().duration(this._duration).attr("x",function(d){return(d.index<c.timeframe.minXBasic)?0:c.chartSize.chartWidth}).attr("width",0).remove();f.select("text").transition().duration(this._duration).attr("x",function(d){return(d.index<c.timeframe.minXBasic)?0:c.chartSize.chartWidth}).remove();f.transition().duration(this._duration).remove()},renderBalanceLine:function(v,D,c){var b=v.append("svg:g").attr("id",c.chartId+"-chart-balances");var a=b.selectAll("g.balanceLines").data(c.data,function(d){return d.date}).enter().append("svg:g").attr("class","balanceLines");a.append("svg:line").attr("class","start sapMRPChartLineEndOfDay").attr("x1",function(d){return c.xScale(d.index-1)}).attr("x2",function(d){return c.xScale(d.index)-c.daySize/21*22/2}).attr("y1",function(d){return c.yScale(d[D].balanceStart)}).attr("y2",function(d){return c.yScale(d[D].balanceStart)});a.append("svg:line").attr("class",function(d){var e=((d[D].demand!=0)&&(d[D].supply!=0))?"sapMRPChartLineIntraday":"sapMRPChartLineEndOfDay";return"intraday "+e}).attr("fullX1",function(d){return c.xScale(d.index)-c.daySize/21*38/2}).attr("x1",function(d){if(d[D].supply!=0){return c.xScale(d.index)-c.daySize/21*38/2}else{return c.xScale(d.index)-c.daySize/21*22/2}}).attr("fullX2",function(d){return c.xScale(d.index)-c.daySize/21*4/2}).attr("x2",function(d){if(d[D].demand!=0){return c.xScale(d.index)-c.daySize/21*4/2}else{return c.xScale(d.index)-c.daySize/21*20/2}}).attr("y1",function(d){return c.yScale(d[D].balanceIntraday)}).attr("y2",function(d){return c.yScale(d[D].balanceIntraday)});a.append("svg:line").attr("class","end sapMRPChartLineEndOfDay").attr("x1",function(d){return c.xScale(d.index)-c.daySize/21*20/2}).attr("x2",function(d){return c.xScale(d.index)}).attr("y1",function(d){return c.yScale(d[D].balanceEnd)}).attr("y2",function(d){return c.yScale(d[D].balanceEnd)})},updateBalanceLine:function(v,D,c){var b=v.select("#"+c.chartId+"-chart-balances");var a=b.selectAll("g.balanceLines").data(c.data,function(d){return d.date});var e=a.enter().append("svg:g").attr("class","balanceLines");e.append("svg:line").attr("class","start sapMRPChartLineEndOfDay").attr("x1",function(d){return(d.index<c.timeframe.minXBasic)?0:c.chartSize.chartWidth}).attr("x2",function(d){return(d.index<c.timeframe.minXBasic)?0:c.chartSize.chartWidth}).attr("y1",c.yScale(0)).attr("y2",c.yScale(0)).transition().duration(this._duration).attr("x1",function(d){return c.xScale(d.index-1)}).attr("x2",function(d){return c.xScale(d.index)-c.daySize/21*22/2}).attr("y1",function(d){return c.yScale(d[D].balanceStart)}).attr("y2",function(d){return c.yScale(d[D].balanceStart)});e.append("svg:line").attr("class",function(d){var g=((d[D].demand!=0)&&(d[D].supply!=0))?"sapMRPChartLineIntraday":"sapMRPChartLineEndOfDay";return"intraday "+g}).attr("x1",function(d){return(d.index<c.timeframe.minXBasic)?0:c.chartSize.chartWidth}).attr("x2",function(d){return(d.index<c.timeframe.minXBasic)?0:c.chartSize.chartWidth}).attr("y1",c.yScale(0)).attr("y2",c.yScale(0)).transition().duration(this._duration).attr("fullX1",function(d){return c.xScale(d.index)-c.daySize/21*38/2}).attr("x1",function(d){if(d[D].supply!=0){return c.xScale(d.index)-c.daySize/21*38/2}else{return c.xScale(d.index)-c.daySize/21*22/2}}).attr("fullX2",function(d){return c.xScale(d.index)-c.daySize/21*4/2}).attr("x2",function(d){if(d[D].demand!=0){return c.xScale(d.index)-c.daySize/21*4/2}else{return c.xScale(d.index)-c.daySize/21*20/2}}).attr("y1",function(d){return c.yScale(d[D].balanceIntraday)}).attr("y2",function(d){return c.yScale(d[D].balanceIntraday)});e.append("svg:line").attr("class","end sapMRPChartLineEndOfDay").attr("x1",function(d){return(d.index<c.timeframe.minXBasic)?0:c.chartSize.chartWidth}).attr("x2",function(d){return(d.index<c.timeframe.minXBasic)?0:c.chartSize.chartWidth}).attr("y1",c.yScale(0)).attr("y2",c.yScale(0)).transition().duration(this._duration).attr("x1",function(d){return c.xScale(d.index)-c.daySize/21*20/2}).attr("x2",function(d){return c.xScale(d.index)}).attr("y1",function(d){return c.yScale(d[D].balanceEnd)}).attr("y2",function(d){return c.yScale(d[D].balanceEnd)});a.select("line.start").transition().duration(this._duration).attr("x1",function(d){return c.xScale(d.index-1)}).attr("y1",function(d){return c.yScale(d[D].balanceStart)}).attr("y2",function(d){return c.yScale(d[D].balanceStart)}).attr("x2",function(d){return c.xScale(d.index)-c.daySize/21*22/2});a.select("line.intraday").attr("class",function(d){return((d[D].demand!=0)&&(d[D].supply!=0))?"sapMRPChartLineIntraday":"sapMRPChartLineEndOfDay"}).attr("x1",function(d){return this.getAttribute("fullX1")}).attr("x2",function(d){return this.getAttribute("fullX2")}).transition().duration(this._duration).attr("y1",function(d){return c.yScale(d[D].balanceIntraday)}).attr("y2",function(d){return c.yScale(d[D].balanceIntraday)}).attr("x1",function(d){if(d[D].supply!=0){return c.xScale(d.index)-c.daySize/21*38/2}else{return c.xScale(d.index)-c.daySize/21*22/2}}).attr("x2",function(d){if(d[D].demand!=0){return c.xScale(d.index)-c.daySize/21*4/2}else{return c.xScale(d.index)-c.daySize/21*20/2}});a.select("line.end").transition().duration(this._duration).attr("x2",function(d){return c.xScale(d.index)}).attr("y1",function(d){return c.yScale(d[D].balanceEnd)}).attr("y2",function(d){return c.yScale(d[D].balanceEnd)}).attr("x1",function(d){return c.xScale(d.index)-c.daySize/21*20/2});var f=a.exit();f.selectAll("line").transition().duration(this._duration).attr("x1",function(d){return(d.index<c.timeframe.minXBasic)?0:c.chartSize.chartWidth}).attr("x2",function(d){return(d.index<c.timeframe.minXBasic)?0:c.chartSize.chartWidth}).remove();f.transition().duration(this._duration).remove()},renderBalanceDot:function(v,D,c){var C=this;var b=v.select("#"+c.chartId+"-chart-balances");var a=b.append("svg:g").attr("class","firstBalance");a.append("svg:line").attr("class","sapMRPChartLineEndOfDay").attr("x1",-11).attr("x2",c.xScale(c.timeframe.minX-1)).attr("y1",c.yScale(c.firstBalance[D])).attr("y2",c.yScale(c.firstBalance[D]));a.append("svg:circle").attr("class","sapMRPChartBalance").attr("cx",c.xScale(c.timeframe.minX-1)).attr("cy",c.yScale(c.firstBalance[D])).attr("r",5);a.append("svg:text").attr("class","sapMRPChartBalanceDescr").attr("x",function(d){return c.xScale(c.timeframe.minX-1)}).attr("y",c.yScale(c.firstBalance[D])).attr("dy","18px").attr("text-anchor","middle").text(C.formatNumber(c.firstBalance[D])).attr("style",function(d){var s="";var t=this.getComputedTextLength();var f=c.chartSize.leftSpace+c.daySize*3/8;if(t>f){s="font-size:"+Math.floor(875/t*f)/1000+"rem"}return s}).attr("dx",function(d){var t=this.getComputedTextLength();if(t>c.chartSize.leftSpace*2){return(t-2*c.chartSize.leftSpace)+"px"}return"0px"});var e=b.selectAll("g.balanceDot").data(c.data,function(d){return d.date}).enter().append("svg:g").attr("class","balanceDot");e.append("svg:circle").attr("class","sapMRPChartBalance").attr("cx",function(d){return c.xScale(d.index)}).attr("cy",function(d){return c.yScale(d[D].balanceEnd)}).attr("r",function(d){return(d[D].demand||d[D].supply)?5:0});if(this.getBalanceDotTooltip()!=""){e.append("svg:title").text(this.getBalanceDotTooltip())}e.append("svg:text").attr("class","sapMRPChartBalanceDescr").attr("x",function(d){return c.xScale(d.index)}).attr("y",function(d){return c.yScale(d[D].balanceEnd)}).attr("dy","18px").attr("text-anchor","middle").text(function(d){if(d[D].demand||d[D].supply){return C.formatNumber(d[D].balanceEnd)}else{return""}}).attr("style",function(d){var s="";var t=this.getComputedTextLength();var f=c.daySize*3/4;if(t>f){s="font-size:"+Math.floor(875/t*f)/1000+"rem"}return s})},updateBalanceDot:function(v,D,c){var C=this;var b=v.select("#"+c.chartId+"-chart-balances");var a=b.select("g.firstBalance");a.select("line").transition().duration(this._duration).attr("x2",c.xScale(c.timeframe.minX-1)).attr("y1",c.yScale(c.firstBalance[D])).attr("y2",c.yScale(c.firstBalance[D]));a.select("circle").transition().duration(this._duration).attr("cx",c.xScale(c.timeframe.minX-1)).attr("cy",c.yScale(c.firstBalance[D]));a.select("text").transition().duration(this._duration).attr("x",function(d){return c.xScale(c.timeframe.minX-1)}).attr("y",c.yScale(c.firstBalance[D])).attr("style","").text(C.formatNumber(c.firstBalance[D])).attr("style",function(d){var s="";var t=this.getComputedTextLength();var h=c.chartSize.leftSpace+c.daySize*3/8;if(t>h){s="font-size:"+Math.floor(875/t*h)/1000+"rem"}return s}).attr("dx",function(d){var t=this.getComputedTextLength();if(t>c.chartSize.leftSpace*2){return(t-2*c.chartSize.leftSpace)+"px"}return"0px"});var e=b.selectAll("g.balanceDot").data(c.data,function(d){return d.date});var f=e.enter().append("svg:g").attr("class","balanceDot");f.append("svg:circle").attr("class","sapMRPChartBalance").attr("cx",function(d){return(d.index<c.timeframe.minXBasic)?0:c.chartSize.chartWidth}).attr("cy",c.yScale(0)).attr("r",function(d){return(d[D].demand||d[D].supply)?5:0}).transition().duration(this._duration).attr("cx",function(d){return c.xScale(d.index)}).attr("cy",function(d){return c.yScale(d[D].balanceEnd)});f.append("svg:text").attr("class","sapMRPChartBalanceDescr").attr("x",function(d){return(d.index<c.timeframe.minXBasic)?0:c.chartSize.chartWidth}).attr("y",c.yScale(0)).attr("dy","18px").attr("text-anchor","middle").text(function(d){if(d[D].demand||d[D].supply){return C.formatNumber(d[D].balanceEnd)}else{return""}}).transition().duration(this._duration).attr("x",function(d){return c.xScale(d.index)}).attr("y",function(d){return c.yScale(d[D].balanceEnd)});e.select("circle.sapMRPChartBalance").transition().duration(this._duration).attr("cx",function(d){return c.xScale(d.index)}).attr("cy",function(d){return c.yScale(d[D].balanceEnd)}).attr("r",function(d){return(d[D].demand||d[D].supply)?5:0});e.select("text").attr("style","").text(function(d){if(d[D].demand||d[D].supply){return C.formatNumber(d[D].balanceEnd)}else{return""}}).transition().duration(this._duration).attr("x",function(d){return c.xScale(d.index)}).attr("y",function(d){return c.yScale(d[D].balanceEnd)}).attr("style",function(d){var s="";var t=this.getComputedTextLength();var h=c.daySize*3/4;if(t>h){s="font-size:"+Math.floor(875/t*h)/1000+"rem"}return s});var g=e.exit();g.select("circle").transition().duration(this._duration).attr("cx",function(d){return(d.index<c.timeframe.minXBasic)?0:c.chartSize.chartWidth}).attr("cy",c.yScale(0)).remove();g.select("text").transition().duration(this._duration).attr("x",function(d){return(d.index<c.timeframe.minXBasic)?0:c.chartSize.chartWidth}).attr("y",c.yScale(0)).remove();g.transition().duration(this._duration).remove()},renderChart:function(d){d=d||this._dataset||"basic";var c=this.getChartSettings(d);var o=this.getOverviewSettings(d);if(c.data.length===0||o.data.length===0){return}this._y0Pos=c.posY0;if(!this.isVisible(d)){return}this.renderBackground(d,c);var a=d3.select("#"+c.chartId+"-chartArea").append("svg:svg").attr("id",c.chartId+"-chart").attr("width",c.chartSize.chartWidth).attr("height",c.chartSize.chartHeight);var v=a.append("svg:g").attr("transform","translate("+c.chartSize.leftSpace+","+c.chartSize.topBorder+")");if(c.data.length){this.renderDays(v,d,c);this.renderShortage(v,d,c);this.renderXTicks(v,d,c);this.renderXAxis(v,d,c);this.renderSupply(v,d,c);this.renderDemand(v,d,c);this.renderBalanceLine(v,d,c);this.renderBalanceDot(v,d,c)}if(this.getShowOverview()&&(o.chartSize.chartHeight>0)){var b=d3.select("#"+o.chartId+"-chartArea").append("svg:svg").attr("id",o.chartId+"-chart").attr("width",o.chartSize.chartWidth).attr("height",o.chartSize.chartHeight+2);var e=b.append("svg:g").attr("transform","translate("+o.chartSize.leftSpace+","+o.chartSize.topBorder+")");if(o.data.length){if(!this.getFixOverviewHeight()){this.renderXAxis(e,d,o);this.renderSupply(e,d,o);this.renderDemand(e,d,o);this.renderBalanceLine(e,d,o)}this.renderOverviewWindow(e,o);this.showDetailsInOverview()}}},updateChart:function(d){d=d||"preview";var c=this.getChartSettings(d);var o=this.getOverviewSettings(d);if(!this.isVisible(d)){return}this.updateBackground(d,c);var a=d3.select("#"+c.chartId+"-chartArea");a.transition().duration(this._duration).style({width:c.chartSize.chartWidth+"px",left:"0px"});var s=d3.select("#"+c.chartId+"-chartArea svg");s.transition().duration(this._duration).attr("width",c.chartSize.chartWidth);var v=d3.select("#"+c.chartId+"-chartArea svg g");if(c.data.length){this.updateDays(v,d,c);this.updateShortage(v,d,c);this.updateXTicks(v,d,c);this.updateXAxis(v,d,c);this.updateSupply(v,d,c);this.updateDemand(v,d,c);this.updateBalanceLine(v,d,c);this.updateBalanceDot(v,d,c)}if(this.getShowOverview()&&(o.chartSize.chartHeight>0)){var b=d3.select("#"+o.chartId+"-chartArea");b.transition().duration(this._duration).style("left","0px");var e=d3.select("#"+o.chartId+"-chartArea svg g");if(o.data.length){this.updateXAxis(e,d,o);this.updateSupply(e,d,o);this.updateDemand(e,d,o);this.updateBalanceLine(e,d,o)}}}});
