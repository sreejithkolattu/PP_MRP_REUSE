/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.declare("i2d.pp.mrpcockpit.reuse.util.CollaborationHelper");jQuery.sap.require("sap.ca.ui.message.message");jQuery.sap.require("i2d.pp.mrpcockpit.reuse.util.CommonConstants");jQuery.sap.require("i2d.pp.mrpcockpit.reuse.util.Wave3CollaborationHelper");i2d.pp.mrpcockpit.reuse.util.CollaborationHelper={setODataModel:function(m,b){this.oModelGlobal=m;this.backendVersion=b},readRequest:function(m){var d=this.oModelGlobal;var u=i2d.pp.mrpcockpit.reuse.util.CommonConstants.ODATA_ENTITYSET_CHANGEREQUESTVENDOR;var c=null;var f="MRPElement eq '";f+=m.PurchaseOrderID;f+="' and MRPElementItem eq '";f+=m.ItemID;f+="' and MRPElementScheduleLine eq '";f+=m.ScheduleLineID;f+="' and Type eq '";f+=m.Type;f+="'";var U=new Array();var t="$filter="+f;U.push(t);d.read(u,null,U,false,function(D,r){c=r.data.results[0]},function(e){c=null});return c},updateRequestBatch:function(d,h,c){var D=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"});var C=new Array();var o=this.oModelGlobal;var O=i2d.pp.mrpcockpit.reuse.util.CommonConstants.CRUD_UPDATE;o.setUseBatch(true);o.clearBatch();var a={};a.SolutionRequestStatus=d.SolutionRequestStatus;a.SolutionRequestNote=d.SolutionRequestNote;a.VendorResponse=d.VendorResponse;if(c==="x30"){a.MRPElementChgAvailyOrRqmtDate=D.format(d.MRPElementChgAvailyOrRqmtDate)+"T00:00:00";a.MRPElementChangedTotalQuantity=(d.MRPElementChangedTotalQuantity).toString();a.MRPElementChgAvailyOrRqmtDate=D.format(d.MRPElementChgAvailyOrRqmtDate)+"T00:00:00"}else{if(d.MRPElementChangedTotalQuantity){a.MRPElementChangedTotalQuantity=(d.MRPElementChangedTotalQuantity).toString()}if(d.MRPElementChgAvailyOrRqmtDate){a.MRPElementChgAvailyOrRqmtDate=D.format(d.MRPElementChgAvailyOrRqmtDate)+"T00:00:00"}if(d.VendorResponse===i2d.pp.mrpcockpit.reuse.util.CommonConstants.VENDOR_RESPONSE_PROPOSED&&d.MaterialShortageSolnRequestLine===null){var b={};b.MRPElementProposedTotalQty=(d.MRPElementProposedQuantity).toString();if(d.MRPElementProposedDate){var e=d.MRPElementProposedDate;b.MRPElementProposedDate=D.format(e)+"T00:00:00";b.MRPElementScheduleLine=d.MRPElementScheduleLine;b.MaterialShortageSolnRequest=d.MaterialShortageSolnRequest;var s=i2d.pp.mrpcockpit.reuse.util.CommonConstants.CRUD_CREATE;var u=i2d.pp.mrpcockpit.reuse.util.CommonConstants.ODATA_ENTITYSET_CHANGEREQUESTPROPOSAL}}else if(d.VendorResponse!==i2d.pp.mrpcockpit.reuse.util.CommonConstants.VENDOR_RESPONSE_PROPOSED&&d.MaterialShortageSolnRequestLine!==null){var b={};var u="/"+d.ChRequest_To_ChRequestProposal.__list[0];var s=i2d.pp.mrpcockpit.reuse.util.CommonConstants.CRUD_DELETE}}C.push(o.createBatchOperation(this._buildUrlForChangeRequestUpdate(d),O,a,null));if(s){C.push(o.createBatchOperation(u,s,b,null))}o.addBatchChangeOperations(C);o.submitBatch(h.fnSuccess,h.fnError,false);return""},createRequestBatch:function(d,h){var c=new Array();var D=this.oModelGlobal;var u=i2d.pp.mrpcockpit.reuse.util.CommonConstants.ODATA_ENTITYSET_CHANGEREQUEST;var o=i2d.pp.mrpcockpit.reuse.util.CommonConstants.CRUD_CREATE;D.setUseBatch(true);D.clearBatch();var a=this._buildODataForChangeRequestCreation(d);var C=D.createBatchOperation(u,o,a,null);c.push(C);D.addBatchChangeOperations(c);D.submitBatch(h.fnSuccess,h.fnError,false);return""},deleteShortageAcceptBatch:function(m,h){if(this.backendVersion===1){return i2d.pp.mrpcockpit.reuse.util.Wave3CollaborationHelper.deleteShortageAcceptBatch(m,h)}var d=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"});var c=[];var D={};var a=d.format(m.MaterialShortageStartDate)+"T00:00:00";var b=d.format(m.MaterialShortageEndDate)+"T00:00:00";var o=this.oModelGlobal;var u=i2d.pp.mrpcockpit.reuse.util.CommonConstants.ODATA_ENTITYSET_ACCEPTSHORTAGE+"(MaterialShortageProfile='"+m.MaterialShortageProfile+"',MaterialShortageProfileCount='"+m.MaterialShortageProfileCount+"',MaterialID='"+m.MaterialID+"',MRPPlant='"+m.MRPPlant+"',MRPArea='"+encodeURIComponent(m.MRPArea)+"',MRPPlanningSegmentType='"+m.MRPPlanningSegmentType+"',MRPPlanningSegmentNumber='"+m.MRPPlanningSegmentNumber+"',MaterialShortageStartDate=datetime'"+encodeURIComponent(a)+"',MaterialShortageEndDate=datetime'"+encodeURIComponent(b)+"')";var O=i2d.pp.mrpcockpit.reuse.util.CommonConstants.CRUD_DELETE;var C=o.createBatchOperation(u,O,D,null);c.push(C);o.addBatchChangeOperations(c);o.submitBatch(h.fnSuccess,h.fnError,true);return""},createShortageAcceptBatch:function(d,h){if(this.backendVersion===1){return i2d.pp.mrpcockpit.reuse.util.Wave3CollaborationHelper.createShortageAcceptBatch(d,h)}var c=new Array();var D=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"});var u=i2d.pp.mrpcockpit.reuse.util.CommonConstants.ODATA_ENTITYSET_ACCEPTSHORTAGE;var o=i2d.pp.mrpcockpit.reuse.util.CommonConstants.CRUD_CREATE;var a=this.oModelGlobal;a.setUseBatch(true);a.clearBatch();if(!d.MaterialShortageProfile||!d.MaterialShortageProfileCount||!d.MaterialID||!d.MRPPlant||!d.MRPArea||!d.MRPPlanningSegmentType||!d.MaterialShortageStartDate||!d.MaterialShortageEndDate){return"SOLUTION_DIALOG_MSG_MANDATORY_KEY_DATA_MISSING"}var b={};b.MaterialShortageProfile=d.MaterialShortageProfile;b.MaterialShortageProfileCount=d.MaterialShortageProfileCount;b.MaterialID=d.MaterialID;b.MRPPlant=d.MRPPlant;b.MRPArea=d.MRPArea;b.MRPPlanningSegmentType=d.MRPPlanningSegmentType;b.MRPPlanningSegmentNumber=d.MRPPlanningSegmentNumber;b.MaterialShortageStartDate=D.format(d.MaterialShortageStartDate)+"T00:00:00";b.MaterialShortageEndDate=D.format(d.MaterialShortageEndDate)+"T00:00:00";b.MaterialShortageQuantity=(d.MaterialShortageQuantity).toString();b.AcceptShortageNote=d.SolutionRequestNote;var C=a.createBatchOperation(u,o,b,null);c.push(C);a.addBatchChangeOperations(c);a.submitBatch(h.fnSuccess,h.fnError,true);return""},updatePurchaseOrderBatch:function(d,h,c,C){if(this.backendVersion===1){return i2d.pp.mrpcockpit.reuse.util.Wave3CollaborationHelper.writePurchaseOrderBatch(d,null,h)}var a=new Array();var o=i2d.pp.mrpcockpit.reuse.util.CommonConstants.CRUD_UPDATE;var D=this.oModelGlobal;D.setUseBatch(true);D.clearBatch();if(!d.MRPElement||!d.MRPElementItem||!d.MRPElementScheduleLine||!d.MaterialID){return"SOLUTION_DIALOG_MSG_MANDATORY_KEY_DATA_MISSING"}if(C==="x30"){if(!d.MaterialShortageSolutionType||!d.MRPElementChgAvailyOrRqmtDate||!d.MRPElementAvailyOrRqmtDate||!d.OrderedQuantity||!d.OrderedChangedQuantity){return"SOLUTION_DIALOG_MSG_MANDATORY_KEY_DATA_MISSING"}}var i=this._adaptItemIdForMM(d.MRPElementItem);var u=i2d.pp.mrpcockpit.reuse.util.CommonConstants.ODATA_ENTITYSET_MM_PO_SCHEDLINE;u+="(PurchaseOrderID='";u+=d.MRPElement;u+="',ItemID='";u+=i;u+="',ScheduleLineID='";u+=d.MRPElementScheduleLine;u+="')";var e=this._buildODataForPurchaseOrderUpdate(d,C);var p={};p.sETag="W/\"'"+d.ChangeStateID+"'\"";var b=D.createBatchOperation(u,o,e,p);a.push(b);if(c===true){o=i2d.pp.mrpcockpit.reuse.util.CommonConstants.CRUD_UPDATE;var m="";var f=this._buildODataForChangeRequestUpdate(d,C,m);u=this._buildUrlForChangeRequestUpdate(d);var B=D.createBatchOperation(u,o,f,null);a.push(B)}D.addBatchChangeOperations(a);D.submitBatch(h.fnSuccess,h.fnError,false);return""},_buildODataForPurchaseOrderUpdate:function(d,c){var D=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"});var e={};switch(c){case"x30":var o=d.MRPElementChgAvailyOrRqmtDate;e.DeliveryDate=D.format(o)+"T00:00:00";e.PurchasingDocumentOrderQty=(d.OrderedChangedQuantity).toString();break;case"540":if(d.VendorResponse===i2d.pp.mrpcockpit.reuse.util.CommonConstants.VENDOR_RESPONSE_PROPOSED){e.DeliveryDate=d.MRPElementProposedDate;e.PurchasingDocumentOrderQty=d.MRPElementProposedQuantity}else{e.DeliveryDate=d.MRPElementChgAvailyOrRqmtDate;e.PurchasingDocumentOrderQty=d.MRPElementChangedTotalQuantity}break;default:jQuery.sap.log.error("CollaborationHelper:_buildODataForPurchaseOrderUpdate - unknown client app: "+c)}return e},_buildODataForChangeRequestUpdate:function(d,c,m){var D=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"});var e={};e.SolutionRequestStatus=d.SolutionRequestStatus;switch(c){case"x30":m=d.MaterialShortageProfile+d.MaterialShortageProfileCount;e.MRPElementChgAvailyOrRqmtDate=D.format(d.MRPElementChgAvailyOrRqmtDate)+"T00:00:00";e.MRPElementOriginalTotalQty=(d.MRPElementOriginalTotalQty).toString();e.MRPElementChangedTotalQuantity=(d.MRPElementChangedTotalQuantity).toString();break;case"540":m=d.MaterialShortageDefinitionID;e.SolutionRequestNote=d.SolutionRequestNote;e.MRPElementOriginalTotalQty=d.MRPElementOriginalTotalQty;e.MRPElementChangedTotalQuantity=d.MRPElementChangedTotalQuantity;e.MRPElementChgAvailyOrRqmtDate=d.MRPElementChgAvailyOrRqmtDate;break;default:jQuery.sap.log.error("CollaborationHelper:_buildODataForChangeRequestUpdate - unknown client app: "+c)}return e},_buildODataForChangeRequestCreation:function(d){var D=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"});var e={};e.MRPElement=d.MRPElement;e.MRPElementItem=this._adaptItemIdForMM(d.MRPElementItem);e.MRPElementScheduleLine=d.MRPElementScheduleLine;e.Vendor=d.Vendor;e.SupplyingPlant=d.SupplyingPlant;e.SolutionRequestStatus=d.SolutionRequestStatus;e.MaterialID=d.MaterialID;e.SolutionRequestNote=d.SolutionRequestNote;e.MRPPlant=d.MRPPlant;e.MRPArea=d.MRPArea;e.MRPPlanningSegmentType=d.MRPPlanningSegmentType;e.MRPPlanningSegmentNumber=d.MRPPlanningSegmentNumber;e.MRPElementCategory=d.MRPElementCategory;e.MaterialGoodsReceiptDuration=d.MaterialGoodsReceiptDuration;e.MRPElementOpenQuantity=(d.MRPElementOpenQuantity).toString();e.MRPElementChgAvailyOrRqmtDate=D.format(d.MRPElementChgAvailyOrRqmtDate)+"T00:00:00";e.MRPElementAvailyOrRqmtDate=D.format(d.MRPElementAvailyOrRqmtDate)+"T00:00:00";e.MRPElementOriginalTotalQty=(d.MRPElementOriginalTotalQty).toString();e.MRPElementChangedTotalQuantity=(d.OrderedChangedQuantity).toString();e.AvailabilityDate=D.format(d.AvailabilityDate)+"T00:00:00";return e},updatePurchaseRequisitionBatch:function(d,h){if(this.backendVersion===1){return i2d.pp.mrpcockpit.reuse.util.Wave3CollaborationHelper.writePurchaseRequisitionBatch(d,null,h)}var c=new Array();var D=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"});var o=this.oModelGlobal;o.setUseBatch(true);o.clearBatch();if(!d.MRPElement||!d.MRPElementItem||!d.MaterialShortageSolutionType||!d.MaterialID||!d.MRPElementChgAvailyOrRqmtDate||!d.MRPElementAvailyOrRqmtDate||!d.MRPElementOriginalTotalQty||!d.MRPElementChangedTotalQuantity){return"SOLUTION_DIALOG_MSG_MANDATORY_KEY_DATA_MISSING"}var i=this._adaptItemIdForMM(d.MRPElementItem);var u=i2d.pp.mrpcockpit.reuse.util.CommonConstants.ODATA_ENTITYSET_MM_PR_ITEM;u+="(PurchaseRequisitionID='";u+=d.MRPElement;u+="',ItemID='";u+=i;u+="')";var e={};var a=d.MRPElementChgAvailyOrRqmtDate;e.DeliveryDate=D.format(a)+"T00:00:00";e.RequestedQuantity=(d.MRPElementChangedTotalQuantity).toString();e.PurchaseRequisitionIsFixed=true;var p={};p.sETag="W/\"'"+d.ChangeStateID+"'\"";var O=i2d.pp.mrpcockpit.reuse.util.CommonConstants.CRUD_UPDATE;var C=o.createBatchOperation(u,O,e,p);c.push(C);o.addBatchChangeOperations(c);o.submitBatch(h.fnSuccess,h.fnError,false);return""},createPurchaseOrderBatch:function(d,h){if(this.backendVersion===1){return i2d.pp.mrpcockpit.reuse.util.Wave3CollaborationHelper.createPurchaseOrderBatch(d,null,h)}var c=new Array();var D=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"});var C=i2d.pp.mrpcockpit.reuse.util.CommonConstants;var M="00010";var f="0001";var A="01";if(!d.MRPElementChgAvailyOrRqmtDate||!M||!f||!d.PurchasingOrganisation||!d.MRPElementChangedTotalQuantity||!d.ReceivingPlant||!d.MaterialID||!d.MaterialBaseUnit||!A){return"SOLUTION_DIALOG_MSG_MANDATORY_KEY_DATA_MISSING"}if(d.MaterialShortageSolutionType===C.SOLUTIONTYPE_PO_CREATE&&!d.Vendor){if(i2d.pp.mrpcockpit.reuse.util.CommonConstants.ONE_CODELINE_TEXT){if(this.getModel('ServiceVersions')){return i2d.pp.mrpcockpit.reuse.util.Helper.getSpecialTextForFieldInt({sI18nID:"SOLUTION_DIALOG_MSG_VENDOR_MISSING_PO",sSoHI18nID:"SOLUTION_DIALOG_MSG_VENDOR_MISSING_POSoH",sModSI18nID:"SOLUTION_DIALOG_MSG_VENDOR_MISSING_POModS",iServiceVersion:this.getModel('ServiceVersions').getData().iServiceSchemaVersion})}}return"SOLUTION_DIALOG_MSG_VENDOR_MISSING_PO"}if(d.MaterialShortageSolutionType===C.SOLUTIONTYPE_TO_CREATE&&!d.SupplyingPlant){return"SOLUTION_DIALOG_MSG_SUPPLYING_PLANT_MISSING_TO"}var o=this.oModelGlobal;var s={};var g=d.MRPElementChgAvailyOrRqmtDate;s.ItemID=M;s.ScheduleLineID=f;if(!g){s.DeliveryDate=" "}else{s.DeliveryDate=D.format(g)+"T00:00:00"}s.PurchasingDocumentOrderQty=this.replaceEmptyValues((d.MRPElementChangedTotalQuantity).toString());var a=new Array();a.push(s);var i={};i.ItemID=M;i.AccountAssignmentID=A;i.SalesOrder=this.replaceEmptyValues(d.SalesOrder);i.SalesOrderItem=this.replaceEmptyValues(d.SalesOrderItem);i.WBSElement=this.replaceEmptyValues(d.WBSElement);var e=new Array();e.push(i);var I={};I.ItemID=M;I.AcctAssignmentCategory=this.replaceEmptyValues(d.AcctAssignmentCategory);I.Material=this.replaceEmptyValues(d.MaterialID);I.PurchasingDocumentOrderQty=this.replaceEmptyValues((d.MRPElementChangedTotalQuantity).toString());I.PurgDocOrderQuantityUnit=this.replaceEmptyValues(d.MaterialBaseUnit);I.ReceivingPlant=this.replaceEmptyValues(d.ReceivingPlant);I.SupplyingStorageLocation=this.replaceEmptyValues(d.SupplyingStorageLocation);I.ReceivingStorageLocation=this.replaceEmptyValues(d.ReceivingStorageLocation);I.PurchasingInfoRecord=this.replaceEmptyValues(d.PurchasingInfoRecord);I.PurchaseContract=this.replaceEmptyValues(d.PurchaseContract);I.PurchaseContractItem=this.replaceEmptyValues(d.PurchaseContractItem);I.MaterialGoodsReceiptDuration=this.replaceEmptyValues(d.MaterialGoodsReceiptDuration);I.MMPurchaseOrderScheduleLines=a;I.MMPurchaseOrderAccAssignments=e;var b=new Array();b.push(I);var u=i2d.pp.mrpcockpit.reuse.util.CommonConstants.ODATA_ENTITYSET_MM_PO_HEADER;var H={};H.PurchasingOrganisation=d.PurchasingOrganisation;H.PurchasingGroup=d.PurchasingGroup;H.CompanyCode=d.CompanyCode;H.Vendor=this.replaceEmptyValues(d.Vendor);H.SupplyingPlant=this.replaceEmptyValues(d.SupplyingPlant);if(d.MaterialShortageSolutionType===C.SOLUTIONTYPE_TO_CREATE){H.StockTransportOrderIndicator=true}else{H.StockTransportOrderIndicator=false}H.MMPurchaseOrderItems=b;var O=i2d.pp.mrpcockpit.reuse.util.CommonConstants.CRUD_CREATE;var j=o.createBatchOperation(u,O,H,null);c.push(j);o.addBatchChangeOperations(c);o.submitBatch(h.fnSuccess,h.fnError,false);return""},replaceEmptyValues:function(v){if(!v){return" "}else{return v}},createPurchaseRequisitionBatch:function(d,h){if(this.backendVersion===1){return i2d.pp.mrpcockpit.reuse.util.Wave3CollaborationHelper.createPurchaseRequisitionBatch(d,null,h)}var c=new Array();var D=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"});var C=i2d.pp.mrpcockpit.reuse.util.CommonConstants;var M="00010";var A="01";if(!d.MRPElementChgAvailyOrRqmtDate||!M||!d.MRPElementChangedTotalQuantity||!d.MaterialID||!d.MaterialBaseUnit||!A){return"SOLUTION_DIALOG_MSG_MANDATORY_KEY_DATA_MISSING"}if(d.MaterialShortageSolutionType===C.SOLUTIONTYPE_PO_CREATE&&!d.Vendor){if(i2d.pp.mrpcockpit.reuse.util.CommonConstants.ONE_CODELINE_TEXT){if(this.getModel('ServiceVersions')){return i2d.pp.mrpcockpit.reuse.util.Helper.getSpecialTextForFieldInt({sI18nID:"SOLUTION_DIALOG_MSG_VENDOR_MISSING_PR",sSoHI18nID:"SOLUTION_DIALOG_MSG_VENDOR_MISSING_PRSoH",sModSI18nID:"SOLUTION_DIALOG_MSG_VENDOR_MISSING_PRModS",iServiceVersion:this.getModel('ServiceVersions').getData().iServiceSchemaVersion})}}return"SOLUTION_DIALOG_MSG_VENDOR_MISSING_PR"}if(d.MaterialShortageSolutionType===C.SOLUTIONTYPE_TO_CREATE&&!d.SupplyingPlant){return"SOLUTION_DIALOG_MSG_SUPPLYING_PLANT_MISSING_TR"}if(d.Vendor&&!d.PurchasingOrganisation){return"SOLUTION_DIALOG_MSG_PURCHASING_ORGANIZATION_MISSING_PR"}var o=this.oModelGlobal;var a={};a.ItemID=M;a.AccountAssignmentID=A;a.SalesOrder=this.replaceEmptyValues(d.SalesOrder);a.SalesOrderItem=this.replaceEmptyValues(d.SalesOrderItem);a.WBSElement=this.replaceEmptyValues(d.WBSElement);var e=new Array();e.push(a);var i={};var f=d.MRPElementChgAvailyOrRqmtDate;i.ItemID=M;i.PurchasingOrganisation=this.replaceEmptyValues(d.PurchasingOrganisation);i.PurchasingGroup=this.replaceEmptyValues(d.PurchasingGroup);i.PurchasingDocumentItemCategory=this.replaceEmptyValues(d.MaterialProcurementType);i.SupplyingPlant=this.replaceEmptyValues(d.SupplyingPlant);i.AcctAssignmentCategory=this.replaceEmptyValues(d.AcctAssignmentCategory);i.Material=this.replaceEmptyValues(d.MaterialID);i.PurReqQuantityUnit=this.replaceEmptyValues(d.MaterialBaseUnit);i.ReceivingPlant=this.replaceEmptyValues(d.ReceivingPlant);i.SupplyingStorageLocation=this.replaceEmptyValues(d.SupplyingStorageLocation);i.ReceivingStorageLocation=this.replaceEmptyValues(d.ReceivingStorageLocation);i.PurchasingInfoRecord=this.replaceEmptyValues(d.PurchasingInfoRecord);i.PurchaseContract=this.replaceEmptyValues(d.PurchaseContract);i.PurchaseContractItem=this.replaceEmptyValues(d.PurchaseContractItem);i.RequestedQuantity=this.replaceEmptyValues((d.MRPElementChangedTotalQuantity).toString());i.FixedVendor=this.replaceEmptyValues(d.Vendor);if(!f){i.DeliveryDate=" "}else{i.DeliveryDate=D.format(f)+"T00:00:00"}i.MaterialGoodsReceiptDuration=this.replaceEmptyValues(d.MaterialGoodsReceiptDuration);i.MMPurchaseReqAccAssignments=e;i.PurchaseRequisitionIsFixed=true;var b=new Array();b.push(i);var u=i2d.pp.mrpcockpit.reuse.util.CommonConstants.ODATA_ENTITYSET_MM_PR_HEADER;var H={};H.MMPurchaseRequisitionItems=b;var O=i2d.pp.mrpcockpit.reuse.util.CommonConstants.CRUD_CREATE;var g=o.createBatchOperation(u,O,H,null);c.push(g);o.addBatchChangeOperations(c);o.submitBatch(h.fnSuccess,h.fnError,false);return""},convertPurchaseRequisitionBatch:function(d,h){if((d.MRPElementChgAvailyOrRqmtDate!==d.MRPElementAvailyOrRqmtDate)||(d.MRPElementChangedTotalQuantity!==d.MRPElementOriginalTotalQty)){this.updatePurchaseRequisitionBatch(d,h)};var n=(parseInt(d.MRPElementOpenQuantity));var c=n+d.MRPElementChangedTotalQuantity-d.MRPElementOriginalTotalQty;if(c<1){return""}var C=new Array();var D=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"});var e=i2d.pp.mrpcockpit.reuse.util.CommonConstants;var M="00010";var f="0001";if(!d.MRPElementChgAvailyOrRqmtDate||!M||!f||!d.MRPElementChangedTotalQuantity||!d.MRPElement){return"SOLUTION_DIALOG_MSG_MANDATORY_KEY_DATA_MISSING"}if((d.MaterialShortageSolutionType===e.SOLUTIONTYPE_PR_CHANGE||d.MaterialShortageSolutionType===e.SOLUTIONTYPE_PR_INCREASE||d.MaterialShortageSolutionType===e.SSOLUTIONTYPE_PR_RESCHEDULE)&&!d.Vendor){if(i2d.pp.mrpcockpit.reuse.util.CommonConstants.ONE_CODELINE_TEXT){if(this.getModel('ServiceVersions')){return i2d.pp.mrpcockpit.reuse.util.Helper.getSpecialTextForFieldInt({sI18nID:"SOLUTION_DIALOG_MSG_VENDOR_MISSING_PO",sSoHI18nID:"SOLUTION_DIALOG_MSG_VENDOR_MISSING_POSoH",sModSI18nID:"SOLUTION_DIALOG_MSG_VENDOR_MISSING_POModS",iServiceVersion:this.getModel('ServiceVersions').getData().iServiceSchemaVersion})}}return"SOLUTION_DIALOG_MSG_VENDOR_MISSING_PO"}if((d.MaterialShortageSolutionType===e.SOLUTIONTYPE_TOR_CHANGE||d.MaterialShortageSolutionType===e.SOLUTIONTYPE_TOR_INCREASE||d.MaterialShortageSolutionType===e.SOLUTIONTYPE_TOR_RESCHEDULE)&&!d.SupplyingPlant){return"SOLUTION_DIALOG_MSG_SUPPLYING_PLANT_MISSING_TO"}var o=this.oModelGlobal;var s={};var g=d.MRPElementChgAvailyOrRqmtDate;s.ItemID=M;s.ScheduleLineID=f;if(!g){s.DeliveryDate=" "}else{s.DeliveryDate=D.format(g)+"T00:00:00"}s.PurchasingDocumentOrderQty=this.replaceEmptyValues((c).toString());var a=new Array();a.push(s);var i={};i.ItemID=M;i.MaterialGoodsReceiptDuration=this.replaceEmptyValues(d.MaterialGoodsReceiptDuration);i.PurchaseRequisition=this.replaceEmptyValues(d.MRPElement);i.PurchaseRequisitionItem=M;i.MMPurchaseOrderScheduleLines=a;var b=new Array();b.push(i);var u=i2d.pp.mrpcockpit.reuse.util.CommonConstants.ODATA_ENTITYSET_MM_PO_HEADER;var H={};if(d.MaterialShortageSolutionType===e.SOLUTIONTYPE_TOR_CHANGE||d.SolutionTyp===e.SOLUTIONTYPE_TOR_INCREASE||d.SolutionTyp===e.SOLUTIONTYPE_TOR_RESCHEDULE){H.StockTransportOrderIndicator=true}else{H.StockTransportOrderIndicator=false}H.MMPurchaseOrderItems=b;var O=i2d.pp.mrpcockpit.reuse.util.CommonConstants.CRUD_CREATE;var j=o.createBatchOperation(u,O,H,null);C.push(j);o.addBatchChangeOperations(C);o.submitBatch(h.fnSuccess,h.fnError,false);return""},onCRPressed:function(e){var s=e.getSource();var c=s.getBindingContext();var S=c.getObject();return this.navToCRApp(S)},navToCRApp:function(c){var e="";var d="";var p=({"MaterialID":c.Material,"SupplyingPlant":c.BusinessPartnerPlant,"MRPElementCategory":c.MRPElementCategory,"MRPElement":c.MRPElement,"MRPElementItem":c.MRPElementItem,"MRPElementScheduleLine":c.MRPElementScheduleLine,"SolutionRequestStatus":c.SolutionRequestStatus,"Vendor":c.Vendor});var f=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService;var C=f&&f("CrossApplicationNavigation");if(C){var h=i2d.pp.mrpcockpit.reuse.util.CommonConstants.NavToCR;var P=sap.ushell.Container.getService("Personalization");var s=h;if(P.getContainer){P.getContainer(s,{validity:i2d.pp.mrpcockpit.reuse.util.CommonConstants.VIEW_STATE_VALIDITY_TIME}).fail(function(){sap.ca.ui.utils.busydialog.releaseBusyDialog();jQuery.sap.log.error("Loading personalization data failed.")}).done(function(o){o.setItemValue("Navigation",p);o.save().done(function(){sap.ca.ui.utils.busydialog.releaseBusyDialog();C.toExternal({target:{semanticObject:"MRPChangeRequest",action:"manage"},params:{"navigationID":h}})}.bind(this))}.bind(this))}else{e=this.oResourceBundle.getText("messNoLaunchpad");return e}}},navToPOApp:function(p){if(p){var P=p.MRPElement;var f=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService;var c=f&&f("CrossApplicationNavigation");if(c){c.toExternal({target:{shellHash:"PurchaseOrder-manage&/managePO/DISPLAY_PO/"+P}})}}},navToSOApp:function(s){var p={FPM_START_PAGE_ID:"START",MODE:3,BO_KEY:s.MRPElement};if(s){var f=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService;var c=f&&f("CrossApplicationNavigation");if(c){c.toExternal({target:{semanticObject:"SalesOrder",action:"maintainSFSWebClient"},params:p})}}},_keyGen:function(){return jQuery.sap.uid()},_buildUrlForChangeRequestUpdate:function(d){var u=i2d.pp.mrpcockpit.reuse.util.CommonConstants.ODATA_ENTITYSET_CHANGEREQUEST;u+="(guid'";u+=d.MaterialShortageSolnRequest;u+="')";return u},_adaptItemIdForMM:function(i){var I=i;if(I.length>5){I=I.substring(1)}return I},updateChangeRequestDocumentsBatch:function(c,h){var C=new Array();var o=i2d.pp.mrpcockpit.reuse.util.CommonConstants.CRUD_UPDATE;var d=this.oModelGlobal;d.setUseBatch(true);d.clearBatch();for(var i=0;i<c.length;i++){var I=i2d.pp.mrpcockpit.reuse.util.CommonConstants.ODATA_ENTITYSET_CHANGEREQUEST;I+="(guid'";I+=c[i].MaterialShortageSolnRequest;I+="')";var e={};e.SolutionRequestStatus=i2d.pp.mrpcockpit.reuse.util.CommonConstants.REQUEST_STATUS_REQUESTED;var p={};p.sETag="W/\"'"+c[i].ChangeStateID+"'\"";var b=d.createBatchOperation(I,o,e,p);d.addBatchChangeOperations([b])}d.submitBatch(h.fnSuccess,h.fnError,false);return""},updatePlannedOrderBatch:function(d,h){var c=new Array();var D=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"});var o=this.oModelGlobal;o.setUseBatch(true);o.clearBatch();if(!d.MRPElement||!d.MRPElementItem||!d.MaterialShortageSolutionType||!d.MaterialID||!d.OrderFinishDate||!d.ChangedOrderFinishDate||!d.MRPElementOriginalTotalQty||!d.MRPElementChangedTotalQuantity){return"SOLUTION_DIALOG_MSG_MANDATORY_KEY_DATA_MISSING"}var i=this._adaptItemIdForMM(d.MRPElementItem);var p=false;var P=false;if((d.OrderFinishDate===d.ChangedOrderFinishDate)&&(d.MRPElementOriginalTotalQty===d.MRPElementChangedTotalQuantity)){p=false}else{p=true};if(d.DialogActivity===i2d.pp.mrpcockpit.reuse.util.CommonConstants.SolutionDialogActivity_EXECUTE){P=false}else{P=true};var u=i2d.pp.mrpcockpit.reuse.util.CommonConstants.ODATA_ENTITYSET_QUICKVIEWS;u+="(MRPElement='";u+=d.MRPElement;u+="',MRPElementItem='";u+=i;u+="',MRPElementScheduleLine='";u+=d.MRPElementScheduleLine;u+="',MRPElementCategory='";u+=d.MRPElementCategory;u+="')";if(p===true){d.QuickviewCategory=i2d.pp.mrpcockpit.reuse.util.CommonConstants.QUICKVIEW_CAT.CHANGE_PLANORD;var e={};e.MRPElement=d.MRPElement;var a=d.ChangedOrderFinishDate;e.OrderFinishDate=D.format(a)+"T12:00:00";e.TotalQuantity=(d.MRPElementChangedTotalQuantity).toString();e.QuickviewCategory=d.QuickviewCategory;e.PlannedOrder=d.PlannedOrder;var O=i2d.pp.mrpcockpit.reuse.util.CommonConstants.CRUD_UPDATE;var C=o.createBatchOperation(u,O,e,null);c.push(C);o.addBatchChangeOperations(c);o.submitBatch(h.fnSuccess,h.fnError,false)};var c=[];o.clearBatch();if(P===true){switch(d.DialogActivity){case i2d.pp.mrpcockpit.reuse.util.CommonConstants.SolutionDialogActivity_EXECUTE:d.QuickviewCategory=i2d.pp.mrpcockpit.reuse.util.CommonConstants.QUICKVIEW_CAT.CHANGE_PLANORD;break;case i2d.pp.mrpcockpit.reuse.util.CommonConstants.SolutionDialogActivity_REQ_CONVERT:d.QuickviewCategory=i2d.pp.mrpcockpit.reuse.util.CommonConstants.QUICKVIEW_CAT.CONV_REQ;break;case i2d.pp.mrpcockpit.reuse.util.CommonConstants.SolutionDialogActivity_PROC_CONVERT:d.QuickviewCategory=i2d.pp.mrpcockpit.reuse.util.CommonConstants.QUICKVIEW_CAT.CONV_PROC;break;case i2d.pp.mrpcockpit.reuse.util.CommonConstants.SolutionDialogActivity_PROD_CONVERT:d.QuickviewCategory=i2d.pp.mrpcockpit.reuse.util.CommonConstants.QUICKVIEW_CAT.CONV_PROD;break};var e={};e.MRPElement=d.MRPElement;var a=d.ChangedOrderFinishDate;e.OrderFinishDate=D.format(a)+"T12:00:00";e.TotalQuantity=(d.MRPElementChangedTotalQuantity).toString();e.QuickviewCategory=d.QuickviewCategory;e.PlannedOrder=d.PlannedOrder;var O=i2d.pp.mrpcockpit.reuse.util.CommonConstants.CRUD_UPDATE;var C=o.createBatchOperation(u,O,e,null);c.push(C);o.addBatchChangeOperations(c);o.submitBatch(h.fnSuccess,h.fnError,false)};return""}};
